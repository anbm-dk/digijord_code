nchar(covariate) - 2,
nchar(covariate)
) %>%
as.numeric() %>%
"*" (ndir_plot) %>%
"/" (1000) %>%
"+" (1)
) %>%
filter(is.finite(Overall))
imp_ogc2 <- imp_ogc %>%
mutate(dir = dir + ndir_plot)
imp_ogc %<>% bind_rows(., imp_ogc2)
# imp_ogc %<>% mutate(dir = row_number())
imp_ogc %<>% mutate(
target = factor(
target,
levels = fractions
)
)
brks <- seq(
from = 0,
to = pi*2,
length.out = 5
)
brks <- seq(
from = min(imp_ogc$dir),
by = (max(imp_ogc$dir) + 1 - min(imp_ogc$dir))/4,
length.out = 4
)
ggplot(imp_ogc, aes(x = dir, y = Overall)) +
coord_polar(
start = - pi/2 - pi/(ndir_plot),
direction = -1) +
geom_col(width = 1, colour = 'black', fill = rgb(0,2/3,2/3,1/2)) +
facet_wrap(
~ target,
ncol = 3
) +
scale_x_continuous(
breaks = brks,
labels = c('E', 'N', 'W', 'S')
)
scale_x_continuous(breaks = brks, labels = c('E', 'N', 'W', 'S')) +
ylab('Importance (variance)') +
theme_bw() +
theme(axis.text.x = element_text(
colour = 'black'),
axis.title.x = element_blank(),
axis.text.y = element_text(colour = 'black'),
panel.grid.major = element_line(color = 'grey'),
panel.grid.minor = element_blank(),
panel.border = element_rect(linewidth = 1)
)
imp_ogc
ndir_plot <- 63
imp_ogc <- imp_all %>%
select(-mean_imp) %>%
pivot_longer(
cols = -covariate,
names_to = "target",
values_to = "Overall"
) %>%
filter(covariate %in% grep('ogc_pi', colnames(obs), value = TRUE)) %>%
group_by(target) %>%
mutate(Overall = Overall*100/max(Overall)) %>%
arrange(covariate) %>%
mutate(
dir = substr(
covariate,
nchar(covariate) - 2,
nchar(covariate)
) %>%
as.numeric() %>%
"*" (ndir_plot) %>%
"/" (1000) %>%
"+" (1)
) %>%
filter(is.finite(Overall))
imp_ogc2 <- imp_ogc %>%
mutate(dir = dir + ndir_plot)
imp_ogc %<>% bind_rows(., imp_ogc2)
# imp_ogc %<>% mutate(dir = row_number())
imp_ogc %<>% mutate(
target = factor(
target,
levels = fractions
)
)
brks <- seq(
from = 0,
to = pi*2,
length.out = 5
)
brks <- seq(
from = min(imp_ogc$dir),
by = (max(imp_ogc$dir) + 1 - min(imp_ogc$dir))/4,
length.out = 4
)
ggplot(imp_ogc, aes(x = dir, y = Overall)) +
coord_polar(
start = - pi/2 - pi/(ndir_plot),
direction = -1) +
geom_col(width = 1, colour = 'black', fill = rgb(0,2/3,2/3,1/2)) +
facet_wrap(
~ target,
ncol = 3
) +
scale_x_continuous(
breaks = brks,
labels = c('E', 'N', 'W', 'S')
)
braks
brks
ndir_plot <- 64
imp_ogc <- imp_all %>%
select(-mean_imp) %>%
pivot_longer(
cols = -covariate,
names_to = "target",
values_to = "Overall"
) %>%
filter(covariate %in% grep('ogc_pi', colnames(obs), value = TRUE)) %>%
group_by(target) %>%
mutate(Overall = Overall*100/max(Overall)) %>%
arrange(covariate) %>%
mutate(
dir = substr(
covariate,
nchar(covariate) - 2,
nchar(covariate)
) %>%
as.numeric() %>%
"*" (ndir_plot) %>%
"/" (1000) %>%
"+" (1)
) %>%
filter(is.finite(Overall))
imp_ogc2 <- imp_ogc %>%
mutate(dir = dir + ndir_plot)
imp_ogc %<>% bind_rows(., imp_ogc2)
# imp_ogc %<>% mutate(dir = row_number())
imp_ogc %<>% mutate(
target = factor(
target,
levels = fractions
)
)
brks <- seq(
from = min(imp_ogc$dir),
by = (max(imp_ogc$dir) + 1 - min(imp_ogc$dir))/4,
length.out = 4
)
ggplot(imp_ogc, aes(x = dir, y = Overall)) +
coord_polar(
start = - pi/2 - pi/(ndir_plot),
direction = -1) +
geom_col(width = 1, colour = 'black', fill = rgb(0,2/3,2/3,1/2)) +
facet_wrap(
~ target,
ncol = 3
) +
scale_x_continuous(
breaks = brks,
labels = c('E', 'N', 'W', 'S')
)
imp_ogc %>% as.data.frame()
ndir_plot <- 64
imp_ogc <- imp_all %>%
select(-mean_imp) %>%
pivot_longer(
cols = -covariate,
names_to = "target",
values_to = "Overall"
) %>%
filter(covariate %in% grep('ogc_pi', colnames(obs), value = TRUE)) %>%
group_by(target) %>%
mutate(Overall = Overall*100/max(Overall)) %>%
arrange(covariate) %>%
mutate(
dir = substr(
covariate,
nchar(covariate) - 2,
nchar(covariate)
) %>%
as.numeric() %>%
"*" (ndir_plot) %>%
"/" (1000) %>%
"+" (1) %>%
round(digits = 0)
) %>%
filter(is.finite(Overall))
imp_ogc2 <- imp_ogc %>%
mutate(dir = dir + ndir_plot)
imp_ogc %<>% bind_rows(., imp_ogc2)
# imp_ogc %<>% mutate(dir = row_number())
imp_ogc %<>% mutate(
target = factor(
target,
levels = fractions
)
)
brks <- seq(
from = min(imp_ogc$dir),
by = (max(imp_ogc$dir) + 1 - min(imp_ogc$dir))/4,
length.out = 4
)
ggplot(imp_ogc, aes(x = dir, y = Overall)) +
coord_polar(
start = - pi/2 - pi/(ndir_plot),
direction = -1) +
geom_col(width = 1, colour = 'black', fill = rgb(0,2/3,2/3,1/2)) +
facet_wrap(
~ target,
ncol = 3
) +
scale_x_continuous(
breaks = brks,
labels = c('E', 'N', 'W', 'S')
)
ndir_plot <- 64
imp_ogc <- imp_all %>%
select(-mean_imp) %>%
pivot_longer(
cols = -covariate,
names_to = "target",
values_to = "Overall"
) %>%
filter(covariate %in% grep('ogc_pi', colnames(obs), value = TRUE)) %>%
group_by(target) %>%
mutate(Overall = Overall*100/max(Overall)) %>%
arrange(covariate) %>%
mutate(
dir = substr(
covariate,
nchar(covariate) - 2,
nchar(covariate)
) %>%
as.numeric() %>%
"*" (ndir_plot) %>%
"/" (1000) %>%
"+" (1) %>%
round(digits = 0)
) %>%
filter(is.finite(Overall))
imp_ogc2 <- imp_ogc %>%
mutate(dir = dir + ndir_plot)
imp_ogc %<>% bind_rows(., imp_ogc2)
# imp_ogc %<>% mutate(dir = row_number())
imp_ogc %<>% mutate(
target = factor(
target,
levels = fractions,
labels = fraction_names
)
)
brks <- seq(
from = min(imp_ogc$dir),
by = (max(imp_ogc$dir) + 1 - min(imp_ogc$dir))/4,
length.out = 4
)
ggplot(imp_ogc, aes(x = dir, y = Overall)) +
coord_polar(
start = - pi/2 - pi/(ndir_plot),
direction = -1) +
geom_col(width = 1, colour = 'black', fill = rgb(0,2/3,2/3,1/2)) +
facet_wrap(
~ target,
ncol = 3
) +
scale_x_continuous(
breaks = brks,
labels = c('E', 'N', 'W', 'S')
) +
ylab('Covariate importance')
ggplot(imp_ogc, aes(x = dir, y = Overall)) +
coord_polar(
start = - pi/2 - pi/(ndir_plot),
direction = -1) +
geom_col(width = 1, colour = 'black', fill = rgb(0,2/3,2/3,1/2)) +
facet_wrap(
~ target,
ncol = 3
) +
scale_x_continuous(
breaks = brks,
labels = c('E', 'N', 'W', 'S')
) +
ylab('Covariate importance') +
theme_bw() +
theme(axis.text.x = element_text(
colour = 'black'),
axis.title.x = element_blank(),
axis.text.y = element_text(colour = 'black'),
panel.grid.major = element_line(color = 'grey'),
panel.grid.minor = element_blank(),
panel.border = element_rect(linewidth = 1)
)
ggplot(imp_ogc, aes(x = dir, y = Overall)) +
coord_polar(
start = - pi/2 - pi/(ndir_plot*2),
direction = -1) +
geom_col(width = 1, colour = 'black', fill = rgb(0,2/3,2/3,1/2)) +
facet_wrap(
~ target,
ncol = 3
) +
scale_x_continuous(
breaks = brks,
labels = c('E', 'N', 'W', 'S')
) +
ylab('Covariate importance') +
theme_bw() +
theme(axis.text.x = element_text(
colour = 'black'),
axis.title.x = element_blank(),
axis.text.y = element_text(colour = 'black'),
panel.grid.major = element_line(color = 'grey'),
panel.grid.minor = element_blank(),
panel.border = element_rect(linewidth = 1)
)
ggplot(imp_ogc, aes(x = dir, y = Overall)) +
coord_polar(
start = - pi/2 - pi/(ndir_plot*2),
direction = -1) +
geom_col(width = 1, colour = 'black', fill = rgb(0,2/3,2/3,1/2)) +
facet_wrap(
~ target,
ncol = 3
) +
scale_x_continuous(
breaks = brks,
labels = c('E', 'N', 'W', 'S')
) +
scale_y_continuous(limits = c(0, 100), expand = c(0, 0))
ylab('Covariate importance') +
theme_bw() +
theme(axis.text.x = element_text(
colour = 'black'),
axis.title.x = element_blank(),
axis.text.y = element_text(colour = 'black'),
panel.grid.major = element_line(color = 'grey'),
panel.grid.minor = element_blank(),
panel.border = element_rect(linewidth = 1)
)
ggplot(imp_ogc, aes(x = dir, y = Overall)) +
coord_polar(
start = - pi/2 - pi/(ndir_plot*2),
direction = -1) +
geom_col(width = 1, colour = 'black', fill = rgb(0,2/3,2/3,1/2)) +
facet_wrap(
~ target,
ncol = 3
) +
scale_x_continuous(
breaks = brks,
labels = c('E', 'N', 'W', 'S')
) +
scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
ylab('Covariate importance') +
theme_bw() +
theme(axis.text.x = element_text(
colour = 'black'),
axis.title.x = element_blank(),
axis.text.y = element_text(colour = 'black'),
panel.grid.major = element_line(color = 'grey'),
panel.grid.minor = element_blank(),
panel.border = element_rect(linewidth = 1)
)
tiff(
paste0(dir_results, "/importance_ogc_test", testn, ".tiff"),
width = 40,
height = 20,
units = "cm",
res = 300
)
ggplot(imp_ogc, aes(x = dir, y = Overall)) +
coord_polar(
start = - pi/2 - pi/(ndir_plot*2),
direction = -1) +
geom_col(width = 1, colour = 'black', fill = rgb(0,2/3,2/3,1/2)) +
facet_wrap(
~ target,
ncol = 3
) +
scale_x_continuous(
breaks = brks,
labels = c('E', 'N', 'W', 'S')
) +
scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
ylab('Covariate importance') +
theme_bw() +
theme(axis.text.x = element_text(
colour = 'black'),
axis.title.x = element_blank(),
axis.text.y = element_text(colour = 'black'),
panel.grid.major = element_line(color = 'grey'),
panel.grid.minor = element_blank(),
panel.border = element_rect(linewidth = 1)
)
try(dev.off())
# 1: Start up
library(terra)
library(magrittr)
library(dplyr)
library(stringr)
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
dir_cov <- dir_dat %>% paste0(., "/covariates")
mycrs <- "EPSG:25832"
dir_tiles <- dir_dat %>%
paste0(., "/tiles_591/")
dir_mask_tiles <- dir_dat %>%
paste0(., "/layers/Mask_LU_tiles/")
# Load tile shape polygons
tile_shapes <- dir_tiles %>%
paste0(., "/tiles.shp") %>%
vect()
# Find covariates
cov_files <- dir_cov %>%
list.files(
pattern = ".tif",
full.names = TRUE
)
# Select relevant covariates
cov_cats <- dir_code %>%
paste0(., "/cov_categories_20231110.csv") %>%
read.table(
sep = ",",
header = TRUE
)
cov_names_all <- cov_files %>%
basename() %>%
tools::file_path_sans_ext(.)
cov_selected <- cov_cats %>%
filter(anbm_use == 1) %>%
select(name) %>%
unlist() %>%
unname()
cov_files_selected <- cov_files[cov_names_all %in% cov_selected]
# Make names for tiles
max_char <- length(tile_shapes) %>%
1:. %>%
as.character() %>%
nchar() %>%
max()
tile_numbers <- length(tile_shapes) %>%
1:. %>%
str_pad(
.,
max_char,
pad = "0"
)
# Cropping function
source("f_cropstack.R")
cov_files_selected
cov_files_notogc <- cov_files_selected %>%
grep('ogc_pi', ., value = TRUE, invert = TRUE)
cov_files_ogc <- cov_files_selected %>%
grep('ogc_pi', ., value = TRUE)
cov_files_ogc <- cov_files_selected %>%
grep('ogc_pi', ., value = TRUE)
library(parallel)
numCores <- detectCores()
numCores
showConnections()
cl <- makeCluster(numCores)
clusterEvalQ(
cl,
{
library(terra)
library(magrittr)
library(dplyr)
library(tools)
}
)
clusterExport(
cl,
c(
"dir_dat",
"dir_tiles",
"dir_code",
"tile_numbers",
"cov_files_ogc",
"dir_mask_tiles"
)
)
parSapplyLB(
cl,
1:length(tile_shapes),
function(j) {
tmpfolder <- paste0(dir_dat, "/Temp/")
terraOptions(memfrac = 0.02, tempdir = tmpfolder)
dir_tile_j <- dir_tiles %>%
paste0(., "/tile_", tile_numbers[j], "/") %T>%
dir.create()
my_ext <- paste0(
dir_mask_tiles, "/Mask_LU_tile_", tile_numbers[j], ".tif"
) %>%
rast()
source(paste0(dir_code, "/f_cropstack.R"))
cropstack(
x = cov_files_ogc,
y = my_ext,
folder = dir_tile_j,
mask = FALSE
)
}
)
stopCluster(cl)
foreach::registerDoSEQ()
rm(cl)
