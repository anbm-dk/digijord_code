raster() %>%
dataType()
newname_x <- sources(r) %>%
basename() %>%
file_path_sans_ext() %>%
gsub("\\.", "_", .) %>%
gsub("-", "_", .) %>%
tolower()
crs(r) <- mycrs
names(r) <- newname_x
outname_x <- dir_cov_renamed %>%
paste0(., "/", newname_x, ".tif")
writeRaster(
r,
datatype = dtyp,
filename = outname_x,
overwrite = TRUE
)
out <- rast(outname_x)
return(out)
}
)
stopCluster(cl)
registerDoSEQ()
rm(cl)
rm(cl)
showConnections()
cov_files <- dir_cov %>%
list.files(
pattern = ".tif",
full.names = TRUE
)
dir_cov_renamed <- dir_dat %>%
paste0(., "/covariates_renamed/") %T>%
dir.create()
library(parallel)
numCores <- detectCores()
numCores
showConnections()
cl <- makeCluster(numCores)
clusterEvalQ(
cl,
{
library(terra)
library(raster)
library(magrittr)
library(dplyr)
library(tools)
}
)
clusterExport(
cl,
c("mycrs",
"dir_cov_renamed",
"cov_files",
"tmpfolder"
)
)
# Use parSapplyLB instead
# March 16, 2023: 60 tiles, 121 predictors, clay: 32 hours
parSapplyLB(
cl,
cov_files,
function(x) {
erraOptions(memfrac = 0.02, tempdir = tmpfolder)
r <- x %>% rast()
dtyp <- x %>%
raster() %>%
dataType()
newname_x <- sources(r) %>%
basename() %>%
file_path_sans_ext() %>%
gsub("\\.", "_", .) %>%
gsub("-", "_", .) %>%
tolower()
crs(r) <- mycrs
names(r) <- newname_x
outname_x <- dir_cov_renamed %>%
paste0(., "/", newname_x, ".tif")
writeRaster(
r,
datatype = dtyp,
filename = outname_x,
overwrite = TRUE
)
out <- rast(outname_x)
return(out)
}
)
stopCluster(cl)
registerDoSEQ()
rm(cl)
foreach::registerDoSEQ()
rm(cl)
cov_files <- dir_cov %>%
list.files(
pattern = ".tif",
full.names = TRUE
)
dir_cov_renamed <- dir_dat %>%
paste0(., "/covariates_renamed/") %T>%
dir.create()
library(parallel)
numCores <- detectCores()
numCores
showConnections()
cl <- makeCluster(numCores)
clusterEvalQ(
cl,
{
library(terra)
library(raster)
library(magrittr)
library(dplyr)
library(tools)
}
)
clusterExport(
cl,
c("mycrs",
"dir_cov_renamed",
"cov_files",
"tmpfolder"
)
)
# Use parSapplyLB instead
# March 16, 2023: 60 tiles, 121 predictors, clay: 32 hours
parSapplyLB(
cl,
cov_files,
function(x) {
terraOptions(memfrac = 0.02, tempdir = tmpfolder)
r <- x %>% rast()
dtyp <- x %>%
raster() %>%
dataType()
newname_x <- sources(r) %>%
basename() %>%
file_path_sans_ext() %>%
gsub("\\.", "_", .) %>%
gsub("-", "_", .) %>%
tolower()
crs(r) <- mycrs
names(r) <- newname_x
outname_x <- dir_cov_renamed %>%
paste0(., "/", newname_x, ".tif")
writeRaster(
r,
datatype = dtyp,
filename = outname_x,
overwrite = TRUE
)
out <- rast(outname_x)
return(out)
}
)
stopCluster(cl)
foreach::registerDoSEQ()
rm(cl)
dir_cov_renamed %>%
list.files(full.names = TRUE) %>%
rast()
dir_cov_renamed %>%
list.files(full.names = TRUE) %>%
rast() %>% names()
library(terra)
library(magrittr)
library(raster)
library(tools)
# TO DO:
# Assign layer names that match the file names
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
mycrs <- "EPSG:25832"
dir_cov <- dir_dat %>%
paste0(., "/covariates/")
cov_files <- dir_cov %>%
list.files(
pattern = ".tif",
full.names = TRUE
)
tmpfolder <- paste0(dir_dat, "/Temp/")
terraOptions(tempdir = tmpfolder)
dem_ind <- grepl(
"dhm",
cov_files
)
dem <- cov_files[dem_ind] %>% rast
crs(dem) <- mycrs
cov_files
cov_cats <- dir_code %>%
paste0(., "/cov_categories_20230323.csv") %>%
read.table(
sep = ";",
header = TRUE,
encoding = "latin1"
)
cov_names <- cov_files %>%
basename() %>%
file_path_sans_ext()
diff(cov_names, cov_cats$name)
?diff
setdiff(cov_names, cov_cats$name)
hillyness <- dir_dat %>%
paste0(., "/hillyness/hillyness.tif") %>%
rast()
hillyness
outname <- dir_cov %>%
paste0(., "/hillyness.tif")
terra::crop(
hillyness,
dem,
filename = outname,
datatype = "INT1U",
overwrite = TRUE
)
hillyness
hillyness <- dir_dat %>%
paste0(., "/hillyness/hillyness.tif") %>%
rast()
names(hillyness) <- "hillyness"
outname <- dir_cov %>%
paste0(., "/hillyness.tif")
terra::crop(
hillyness,
dem,
filename = outname,
datatype = "INT1U",
overwrite = TRUE
)
terra::crop(
hillyness,
dem,
filename = outname,
datatype = "INT2S",
overwrite = TRUE
)
hillyness
rast(outname)
?writeRaster
NAflag(hillyness)
hillyness <- dir_dat %>%
paste0(., "/hillyness/hillyness.tif") %>%
rast()
names(hillyness) <- "hillyness"
outname <- dir_cov %>%
paste0(., "/hillyness.tif")
terra::crop(
hillyness,
dem,
filename = outname,
datatype = "INT1U",
overwrite = TRUE,
NAflag = NA
)
plot(hillyness)
hillyness <- dir_dat %>%
paste0(., "/hillyness/hillyness.tif") %>%
rast()
names(hillyness) <- "hillyness"
NAflag(hillyness) <- 124
plot(hillyness)
hillyness <- dir_dat %>%
paste0(., "/hillyness/hillyness.tif") %>%
rast()
names(hillyness) <- "hillyness"
NAflag(hillyness) <- 128
plot(hillyness)
outname <- dir_cov %>%
paste0(., "/hillyness.tif")
terra::crop(
hillyness,
dem,
filename = outname,
datatype = "INT1U",
overwrite = TRUE
)
rast(outname) %>% plot()
rast(outname) %>% plot()
cov_cats <- dir_code %>%
paste0(., "/cov_categories_20230323.csv") %>%
read.table(
sep = ";",
header = TRUE,
encoding = "latin1"
)
cov_names <- cov_files %>%
basename() %>%
file_path_sans_ext()
setdiff(cov_names, cov_cats$name)
cov_cats <- dir_code %>%
paste0(., "/cov_categories_20230323.csv") %>%
read.table(
sep = ";",
header = TRUE,
encoding = "latin1"
)
cov_cats <- dir_code %>%
paste0(., "/cov_categories_20230323.csv") %>%
read.table(
sep = ";",
header = TRUE,
encoding = "latin1"
)
cov_cats <- dir_code %>%
paste0(., "/cov_categories_20230323.csv") %>%
read.table(
sep = ";",
header = TRUE,
encoding = "latin1"
)
cov_names <- cov_files %>%
basename() %>%
file_path_sans_ext()
setdiff(cov_names, cov_cats$name)
cov_files <- dir_cov %>%
list.files(
pattern = ".tif",
full.names = TRUE
)
cov_names <- cov_files %>%
basename() %>%
file_path_sans_ext()
setdiff(cov_names, cov_cats$name)
cov_cats <- dir_code %>%
paste0(., "/cov_categories_20230323.csv") %>%
read.table(
sep = ";",
header = TRUE,
encoding = "latin1"
)
cov_files <- dir_cov %>%
list.files(
pattern = ".tif",
full.names = TRUE
)
cov_names <- cov_files %>%
basename() %>%
file_path_sans_ext()
setdiff(cov_names, cov_cats$name)
cov_files <- dir_cov %>%
list.files(
pattern = ".tif",
full.names = TRUE
)
squareshape <- dir_dat %>%
paste0(., "/testarea_10km/square10km.shp") %>%
vect
square_ext <- squareshape %>%
ext %>%
round(-1)
outfolder <- dir_dat %>%
paste0(., "/testarea_10km/covariates/")
outfolder %>% dir.create()
cropstack <- function(
x,  # list of files
y,  # extent
folder # target folder
) {
for(i in 1:length(x)) {
r <- x[i] %>% rast
dtype <- r %>%
sources %>%
raster::raster(.) %>%
raster::dataType(.)
outname <- r %>%
sources %>%
basename %>%
tools::file_path_sans_ext(.) %>%
make.names %>%
paste0(folder, ., ".tif")
r %>%
crop(y = y) %>%
writeRaster(
datatype = dtype,
filename = outname,
overwrite = TRUE
)
}
}
cov_files %>%
cropstack(
y = square_ext,
folder = outfolder
)
library(terra)
library(magrittr)
library(exactextractr)
library(sf)
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
mycrs <- "EPSG:25832"
# 1 Load observations
dir_obs_proc <- dir_dat %>%
paste0(., "/observations/processed/")
dsc <- dir_obs_proc %>%
paste0(., "dsc.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SEGES <- dir_obs_proc %>%
paste0(., "SEGES.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SINKS <- dir_obs_proc %>%
paste0(., "SINKS.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
# 2 Load covariates
cov_dir <- dir_dat %>% paste0(., "/covariates")
cov_files <- cov_dir %>% list.files
cov_names <- cov_files %>% tools::file_path_sans_ext()
cov <- paste0(cov_dir, "/", cov_files) %>%
rast()
names(cov) <- cov_names
crs(cov) <- mycrs
# 3 Create buffers (40 m = ~ 0.5 ha)
buffer_dsc <- terra::buffer(
dsc,
width = 40
) %>%
st_as_sf()
buffer_SEGES <- terra::buffer(
SEGES,
width = 40
) %>%
st_as_sf()
# 4 Extract
dsc_extr <- terra::extract(
x = cov,
y = dsc,
ID = FALSE,
)
# buffer_dsc_extr <- exact_extract(
#     x = cov,
#     y = buffer_dsc,
#     fun = "mean",
#     progress = TRUE
#   )
# names(buffer_dsc_extr) <- names(cov)
SEGES_extr <- terra::extract(
x = cov,
y = SEGES,
ID = FALSE,
)
# buffer_SEGES_extr <- exact_extract(
#   x = cov,
#   y = buffer_SEGES,
#   fun = "mean",
#   progress = TRUE
# )
# names(buffer_SEGES_extr) <- names(cov)
SINKS_extr <- terra::extract(
x = cov,
y = SINKS,
ID = FALSE,
)
# 5 Write to file
dir_extr <- dir_dat %>%
paste0(., "/extracts/")
write.table(
dsc_extr,
paste0(dir_extr, "dsc_extr.csv"),
row.names = FALSE,
sep = ";"
)
# write.table(
#   buffer_dsc_extr,
#   paste0(dir_extr, "buffer_dsc_extr.csv"),
#   row.names = FALSE,
#   sep = ";"
# )
write.table(
SEGES_extr,
paste0(dir_extr, "SEGES_extr.csv"),
row.names = FALSE,
sep = ";"
)
# write.table(
#   buffer_SEGES_extr,
#   paste0(dir_extr, "buffer_SEGES_extr.csv"),
#   row.names = FALSE,
#   sep = ";"
# )
write.table(
SINKS_extr,
paste0(dir_extr, "SINKS_extr.csv"),
row.names = FALSE,
sep = ";"
)
