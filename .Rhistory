height = 16,
units = "cm",
res = 300
)
plot(maps_10km_stack2, col = cividis(100))
dev.off()
JB <- function(clay, silt, sand_f, SOM, CaCO3)
{
out <- rep(0, length(clay))
out[CaCO3 > 10] <- 12
out[out == 0 & SOM > 10] <- 11
out[out == 0 & clay < 5 & silt < 20 & sand_f < 50] <- 1
out[out == 0 & clay < 5 & silt < 20] <- 2
out[out == 0 & clay < 10 & silt < 25 & sand_f < 40] <- 3
out[out == 0 & clay < 10 & silt < 25]<-4
out[out == 0 & clay < 15 & silt < 30 & sand_f < 40] <- 5
out[out == 0 & clay < 15 & silt < 30] <- 6
out[out == 0 & clay < 25 & silt < 35] <- 7
out[out == 0 & clay < 45 & silt < 45] <- 8
out[out == 0 & silt < 50] <- 9
out[out == 0] <- 10
return(out)
}
# maps_10km_s2 <- c(maps_10km[[1]], maps_10km[[2]], maps_10km[[3]], exp(maps_10km[[5]])/0.568, exp(maps_10km[[6]]))
maps_10km_s2 <- c(maps_10km[[1]], maps_10km[[2]], maps_10km[[3]], maps_10km[[5]]/0.568, maps_10km[[6]])
maps_10km_jb <- lapp(maps_10km_s2, JB) %>% as.factor()
myrgb <- col2rgb(mycolors)
tsp <- as.TSP(dist(t(myrgb)))
set.seed(1)
sol <- solve_TSP(tsp, control = list(repetitions = 1e3))
ordered_cols <- mycolors[sol]
# ggplot2::qplot(x = 1:12, y = 1, fill = I(ordered_cols), geom = "col", width = 1) + ggplot2::theme_void()
tiff(
paste0(dir_results, "/JB_test", testn, ".tiff"),
width = 15,
height = 10,
units = "cm",
res = 300
)
plot(
maps_10km_jb,
col = ordered_cols[levels(maps_10km_jb)[[1]]$ID],
main = "JB-nummer"
)
dev.off()
models_loaded <- lapply(
1:6,
function(x) {
out <- fractions[x] %>%
paste0(dir_results, "/model_", ., ".rds") %>%
readRDS()
return(out)
}
)
# models <- models_loaded
names(models) <- fractions
# Model summary
models_sum <- lapply(models, function(x) {
out <- x$results %>%
filter(RMSEw == min(RMSEw))
return(out)
}
) %>%
bind_rows() %>%
mutate(
Fraction = fractions,
.before = 1
) %T>%
write.table(
file = paste0(dir_results, "/models_sum.csv"),
sep = ";",
row.names = FALSE
)
models_sum
# Covariate importance
imp_all <- models %>%
seq_along() %>%
lapply(
function(x) {
out <- varImp(models[[x]])$importance %>%
as.data.frame() %>%
rownames_to_column(var = "covariate") %>%
mutate(fraction = names(models)[x])
return(out)
}
) %>%
bind_rows() %>%
pivot_wider(
id_cols = covariate,
names_from = fraction,
values_from = Overall
) %>%
rowwise() %>%
mutate(mean_imp = mean(c_across(-covariate))) %>%
arrange(-mean_imp) %T>%
write.table(
file = paste0(dir_results, "/var_imp.csv"),
sep = ";",
row.names = FALSE
)
imp_all
# Inspect models
get_acc <- function(x2, i2) {
df <- x2$pred %>%
arrange(rowIndex) %>%
distinct(rowIndex, .keep_all = TRUE) %>%
dplyr::select(., c(pred, obs, weights)) %>%
mutate(
pred = ifelse(pred < 0, 0, pred)
)
# if (i2 > 4) df %<>% exp
df %<>% bind_cols(x2$trainingData)
r2_all <- df %$% get_R2w(cbind(pred, obs), weights)
r2_bare <- df %>%
filter(!is.na(s2_geomedian_b2)) %$%
get_R2w(cbind(pred, obs), weights)
r2_covered <- df %>%
filter(is.na(s2_geomedian_b2)) %$%
get_R2w(cbind(pred, obs), weights)
rmse_all <- df %$% get_RMSEw(cbind(pred, obs), weights)
rmse_bare <- df %>%
filter(!is.na(s2_geomedian_b2)) %$%
get_RMSEw(cbind(pred, obs), weights)
rmse_covered <- df %>%
filter(is.na(s2_geomedian_b2)) %$%
get_RMSEw(cbind(pred, obs), weights)
out <- data.frame(
r2_all,
r2_bare,
r2_covered,
rmse_all,
rmse_bare,
rmse_covered
)
return(out)
}
acc_all <- foreach(i = 1:6, .combine = rbind) %do%
get_acc(models[[i]], i)
acc_all %<>% mutate(fraction = fraction_names, .before = 1)
write.table(
acc_all,
paste0(dir_results, "/acc_all_test", testn, ".csv"),
sep = ";",
row.names = FALSE
)
getpred <- function(x2, i2) {
df <- x2$pred %>%
arrange(rowIndex) %>%
distinct(rowIndex, .keep_all = TRUE) %>%
dplyr::select(., c(pred, obs)) %>%
mutate(
pred = ifelse(pred < 0, 0, pred)
)
# if (i2 > 4) df %<>% exp
df %<>% mutate(
fraction = fractions[i2],
upper = quantile(obs, 0.99)
) %>%
filter(obs < upper) %>%
filter(pred < upper) %>%
filter(obs >= 0)
return(df)
}
allpred <- foreach(i = 1:6, .combine=rbind) %do%
getpred(models[[i]], i)
allpred$fraction %<>% factor(levels = fractions)
levels(allpred$fraction) <- c(
"Clay", "Silt", "Fine sand", "Coarse sand", "SOC", "CaCO3"
)
tiff(
paste0(dir_results, "/accuracy_test", testn, ".tiff"),
width = 15,
height = 10,
units = "cm",
res = 300
)
allpred %>%
ggplot(aes(x = obs, y = pred)) +
geom_point(alpha = .01, shape = 16) +
facet_wrap(~ fraction, nrow = 2, scales = "free") +
theme(aspect.ratio = 1) +
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
geom_abline(col = "red") +
geom_blank(aes(y = upper)) +
geom_blank(aes(x = upper)) +
geom_blank(aes(y = 0)) +
geom_blank(aes(x = 0)) +
xlab("Observation (%)") +
ylab("Prediction (%)")
dev.off()
# Covariate importance
library(colorRamps)
library(rcartocolor) # for colorblind palette
mycolors <- carto_pal(12, "Safe") %>% sort()
library(TSP)
l <- list()
ntop <- 20
for(i in 1:length(models))
{
l[[i]] <- varImp(models[[i]])$importance %>%
as_tibble(rownames = "covariate") %>%
drop_na %>%
arrange(- Overall) %>%
slice_head(n = ntop) %>%
mutate(target = fractions[i]) %>%
mutate(rank = 1:ntop)
}
l %<>% bind_rows() %>%
mutate(
target = factor(
target,
levels = fractions
)
)
l_cat <- cov_cats %>%
mutate(
covariate = name,
category = ifelse(
category == "basic",
scorpan,
category
)
)
l %<>%
left_join(l_cat)
l %<>%
ungroup() %>%
arrange(target, Overall) %>%
mutate(order = row_number())
l$category %<>% as.factor()
# levels(l$category) <- c(
#   "Bare soil",
#   "Spatial position",
#   "Parent materials",
#   "Topography",
#   "S2 time series",
#   "Soil"
# )
catcolors <- l$category %>%
levels() %>%
length() %>%
carto_pal(., "Safe")
names(catcolors) <- levels(l$category)
colScale <- scale_fill_manual(name = "category", values = catcolors)
tiff(
paste0(dir_results, "/importance_test", testn, ".tiff"),
width = 40,
height = 20,
units = "cm",
res = 300
)
l %>%
ggplot(aes(x = order, y = Overall, bg = category)) +
geom_col() +
facet_wrap(
~ target,
ncol = 3,
scales = "free"
) +
# xlim(1, ntop) +
ylim(0, NA) +
coord_flip() +
scale_x_continuous(
breaks = l$order,
labels = l$covariate,
expand = c(0, 0)
) +
colScale
dev.off()
# 10: Make maps for the test area
outfolder <- dir_dat %>%
paste0(., "/testarea_10km/covariates/")
cov_10km <- outfolder %>%
list.files(full.names = TRUE) %>%
rast()
predfolder <- dir_dat %>%
paste0(., "/testarea_10km/predictions_", testn, "/") %T>%
dir.create()
source("f_predict_passna.R")
# Make the maps
maps_10km <- list()
showConnections()
for(i in 1:length(fractions))
{
frac <- fractions[i]
maps_10km[[i]] <- predict(
cov_10km,
models[[i]],
fun = predict_passna,
na.rm = FALSE,
filename = paste0(predfolder, frac,  "_10km.tif"),
overwrite = TRUE,
const = data.frame(
SOM_removed = 1,
year = 2010
),
n_const = 2,
n_digits = 1
)
}
maps_10km <- predfolder %>%
paste0(., fractions,  "_10km.tif") %>%
rast()
names(maps_10km) <- fractions
# Looking at 10 km maps
library(viridisLite)
plot(maps_10km, col = cividis(100), box = FALSE)
# maps_10km_stack2 <- c(
#   maps_10km[[1:4]],
#   exp(maps_10km[[5]]),
#   exp(maps_10km[[6]])
# )
maps_10km_stack2 <- round(maps_10km, 4)
names(maps_10km_stack2) <- fraction_names
tiff(
paste0(dir_results, "/maps_test", testn, ".tiff"),
width = 24,
height = 16,
units = "cm",
res = 300
)
plot(maps_10km_stack2, col = cividis(100))
dev.off()
JB <- function(clay, silt, sand_f, SOM, CaCO3)
{
out <- rep(0, length(clay))
out[CaCO3 > 10] <- 12
out[out == 0 & SOM > 10] <- 11
out[out == 0 & clay < 5 & silt < 20 & sand_f < 50] <- 1
out[out == 0 & clay < 5 & silt < 20] <- 2
out[out == 0 & clay < 10 & silt < 25 & sand_f < 40] <- 3
out[out == 0 & clay < 10 & silt < 25]<-4
out[out == 0 & clay < 15 & silt < 30 & sand_f < 40] <- 5
out[out == 0 & clay < 15 & silt < 30] <- 6
out[out == 0 & clay < 25 & silt < 35] <- 7
out[out == 0 & clay < 45 & silt < 45] <- 8
out[out == 0 & silt < 50] <- 9
out[out == 0] <- 10
return(out)
}
# maps_10km_s2 <- c(maps_10km[[1]], maps_10km[[2]], maps_10km[[3]], exp(maps_10km[[5]])/0.568, exp(maps_10km[[6]]))
maps_10km_s2 <- c(maps_10km[[1]], maps_10km[[2]], maps_10km[[3]], maps_10km[[5]]/0.568, maps_10km[[6]])
maps_10km_jb <- lapp(maps_10km_s2, JB) %>% as.factor()
myrgb <- col2rgb(mycolors)
tsp <- as.TSP(dist(t(myrgb)))
set.seed(1)
sol <- solve_TSP(tsp, control = list(repetitions = 1e3))
ordered_cols <- mycolors[sol]
# ggplot2::qplot(x = 1:12, y = 1, fill = I(ordered_cols), geom = "col", width = 1) + ggplot2::theme_void()
tiff(
paste0(dir_results, "/JB_test", testn, ".tiff"),
width = 15,
height = 10,
units = "cm",
res = 300
)
plot(
maps_10km_jb,
col = ordered_cols[levels(maps_10km_jb)[[1]]$ID],
main = "JB-nummer"
)
dev.off()
# 08: Script for making maps
library(parallel)
library(caret)
library(terra)
library(magrittr)
library(dplyr)
library(xgboost)
library(foreach)
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
testn <- 11
mycrs <- "EPSG:25832"
dir_results <- dir_dat %>%
paste0(., "/results_test_", testn, "/")
fractions <- c("clay", "silt", "fine_sand", "coarse_sand", "logSOC", "logCaCO3")
fractions_alt <- c("clay", "silt", "fine_sand", "coarse_sand", "SOC", "CaCO3")
fractions <- fractions_alt
fraction_names <- c(
"Clay", "Silt", "Fine sand", "Coarse sand", "SOC", "CaCO3"
)
fraction_names_underscore <- c(
"Clay", "Silt", "Fine_sand", "Coarse_sand", "SOC", "CaCO3"
)
dir_cov <- dir_dat %>% paste0(., "/covariates")
cov_files <- dir_cov %>% list.files()
cov_names <- cov_files %>% tools::file_path_sans_ext()
cov_cats <- dir_code %>%
paste0(., "/cov_categories_20230501.csv") %>%
read.table(
sep = ";",
header = TRUE
)
cov_selected <- cov_cats %>%
filter(anbm_use == 1) %>%
dplyr::select(., name) %>%
unlist() %>%
unname()
source("f_predict_passna.R")
# Load models
models_loaded <- lapply(
1:6,
function(x) {
out <- fractions[x] %>%
paste0(dir_results, "/model_", ., ".rds") %>%
readRDS()
return(out)
}
)
models <- models_loaded
# Tiles for model prediction
numCores <- detectCores()
numCores
dir_tiles <- dir_dat %>%
paste0(., "/tiles_591/")
subdir_tiles <- dir_tiles %>% list.dirs() %>% .[-1]
dir_pred_all <- dir_results %>%
paste0(., "/predictions/") %T>%
dir.create()
dir_pred_tiles <- dir_pred_all  %>%
paste0(., "/tiles/") %T>%
dir.create()
n_digits <- 1
for (i in 1:length(fractions)) {
frac <- fraction_names_underscore[i]
dir_pred_tiles_frac <- dir_pred_tiles %>%
paste0(., "/", frac, "/") %T>%
dir.create()
model_i <- models[[i]]
showConnections()
cl <- makeCluster(numCores)
clusterEvalQ(
cl,
{
library(terra)
library(caret)
library(xgboost)
library(magrittr)
library(dplyr)
}
)
clusterExport(
cl,
c("i",
"model_i",
"subdir_tiles",
"dir_pred_tiles_frac",
"frac",
"cov_names",
"cov_selected",
"predict_passna",
"dir_dat",
"n_digits"
)
)
parSapplyLB(
cl,
1:length(subdir_tiles),
function(x) {
tmpfolder <- paste0(dir_dat, "/Temp/")
terraOptions(memfrac = 0.02, tempdir = tmpfolder)
cov_x <- subdir_tiles[x] %>%
list.files(full.names = TRUE) %>%
rast()
names(cov_x) <- cov_names
cov_x2 <- subset(cov_x, cov_selected)
tilename_x <- basename(subdir_tiles[x])
outname_x <- dir_pred_tiles_frac %>%
paste0(., "/", frac, "_", tilename_x, ".tif")
outmap <- predict(
cov_x2,
model_i,
fun = predict_passna,
na.rm = FALSE,
const = data.frame(
SOM_removed = 1,
year = 2010
),
n_const = 2,
n_digits = 1,
filename = outname_x,
overwrite = TRUE
)
# if (i > 4) {
#   outmap2 <- terra::exp(outmap)
#   outmap <- outmap2
# }
# terra::math(
#   outmap,
#   "round",
#   digits = n_digits,
#   filename = outname_x,
#   overwrite = TRUE
#   )
}
)
stopCluster(cl)
foreach::registerDoSEQ()
rm(cl)
outtiles_frac <- dir_pred_tiles_frac %>%
list.files(full.names = TRUE) %>%
sprc()
merge(
outtiles_frac,
filename = paste0(dir_pred_all, frac, "_merged.tif"),
overwrite = TRUE
)
}
?file_path_sans_ext
