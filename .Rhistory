unlist() %>%
unname()
cor_top20 <- cov_pts %>%
select(any_of(top20_names)) %>%
cor()
# 2.3 Find important uncorrelated covariates
# imp_selected <- imp_all %>%
#   filter(
#     !(Covariate %in% grep('fuzzy', Covariate, value = TRUE)),
#     !(Covariate %in% c("upper", "lower", "SOM_removed")),
#     !(Covariate %in% grep('ogc_pi', Covariate, value = TRUE)),
#     is.finite(mean)
#   )
imp_selected <- imp_all %>%
filter(
!(Covariate %in% grep('fuzzy', Covariate, value = TRUE)),
!(Covariate %in% c("upper", "lower", "SOM_removed")),
# !(Covariate %in% grep('ogc_pi', Covariate, value = TRUE)),
is.finite(mean)
)
top_i <- imp_selected %>%
slice_head(n = 1) %>%
select(Covariate) %>%
unlist() %>%
unname()
for (i in 1:19) {
imp_i <- imp_selected %>%
filter(!(Covariate %in% top_i)) %>%
mutate(imp100 = mean/max(mean, na.rm = TRUE))
pts_top_i <- cov_pts %>% select(any_of(top_i))
pts_imp_i <- cov_pts %>% select(any_of(imp_i$Covariate))
max_cor <- cor(
pts_imp_i,
pts_top_i
) %>%
# "^"(2) %>%
abs() %>%
apply(., 1, max) %>%
unname()
imp_i %<>%
mutate(
max_cor = max_cor,
imp_new = imp100*(1 - max_cor)
) %>%
arrange(-imp_new)
top_i <- imp_i %>%
slice_head(n = 1) %>%
select(Covariate) %>%
unlist() %>%
unname() %>%
c(top_i, .)
}
top_i
# Everything:
# "cwl_10m_fuzzy"                          "fuzzy_geology_7"
# "filled_s1_baresoil_composite_vh_8_days" "fuzzy_georeg_3"
# "vdtochn"                                "ogc_pi906"
# "wetlands_10m_fuzzy"                     "fuzzy_landscape_11"
# "dhm2015_terraen_10m"                    "filled_s2_geomedian_b11"
# "fuzzy_geology_5"                        "fuzzy_landscape_9"
# "chelsa_bio17_1981_2010_10m"             "filled_s2_geomedian_b3"
# "flooded_depth_10m_mean"                 "s2_count_max10_fuzzy"
# "filled_s1_baresoil_composite_vv_8_days" "ogc_pi438"
# "chelsa_bio15_1981_2010_10m"             "slope"
# No categorical covariates
# "filled_s1_baresoil_composite_vh_8_days" "vdtochn"
# "chelsa_bio17_1981_2010_10m"             "dhm2015_terraen_10m"
# "filled_s2_geomedian_b11"                "flooded_depth_10m_mean"
# "chelsa_bio15_1981_2010_10m"             "filled_s2_geomedian_b3"
# "ogc_pi906"                              "filled_s1_baresoil_composite_vv_8_days"
# "ogc_pi375"                              "valley_depth"
# "slope"                                  "filled_s2_geomedian_b12"
# "sin_aspect_radians"                     "s2_geomedian_20180701_20180731_b4"
# "ogc_pi125"                              "cos_aspect_radians"
# "s2_geomedian_20180408_20180515_b3"      "standardized_height"
# No categorical covariates or OGCs:
#  "filled_s1_baresoil_composite_vh_8_days" "vdtochn"
#  "chelsa_bio17_1981_2010_10m"             "dhm2015_terraen_10m"
#  "filled_s2_geomedian_b11"                "flooded_depth_10m_mean"
#  "chelsa_bio15_1981_2010_10m"             "filled_s2_geomedian_b3"
#  "filled_s1_baresoil_composite_vv_8_days" "valley_depth"
#  "slope"                                  "filled_s2_geomedian_b12"
#  "sin_aspect_radians"                     "s2_geomedian_20180701_20180731_b4"
#  "cos_aspect_radians"                     "s2_geomedian_20180408_20180515_b3"
#  "standardized_height"                    "rvb_bios"
#  "chelsa_bio16_1981_2010_10m"             "s2_geomedian_20180701_20180731_b8"
# 2.4 Good candidates:
candidates_top <- c(
"filled_s1_baresoil_composite_vh_8_days",
"vdtochn",
"ogc_pi906",
"dhm2015_terraen_10m",
"filled_s2_geomedian_b11",
"chelsa_bio17_1981_2010_10m",
"filled_s2_geomedian_b3",
"flooded_depth_10m_mean",
"s2_count_max10_fuzzy",
"filled_s1_baresoil_composite_vv_8_days"
)
# Other variables to check:
candidates_other <- c(
"ogc_pi438",
"chelsa_bio15_1981_2010_10m",
"slope",
"valley_depth",
"filled_s2_geomedian_b12",
"sin_aspect_radians",
"s2_geomedian_20180701_20180731_b4",
"cos_aspect_radians",
"s2_geomedian_20180408_20180515_b3",
"standardized_height"
)
# Probably not worth checking:
# "rvb_bios" (categorical)
# "chelsa_bio16_1981_2010_10m" (probably just a proxy for geology)
# "s2_geomedian_20180701_20180731_b8" (ok effect for coarse sand)
# 3 Make PDPs for all selected covariates for each fraction
# 3.0 Trial plots using observations
var_i <- 10
var1 <- "s2_geomedian_20180701_20180731_b8"
# var1 <- candidates_top[var_i]
# var1 <- candidates_other[var_i]
# obs %>%
#   select(any_of(c(fractions, var1))) %>%
#   tidyr::pivot_longer(
#     cols = any_of(fractions),
#     names_to = "fraction",
#     values_to = "value",
#     values_drop_na = TRUE
#     ) %>%
#   mutate(fraction = factor(fraction, levels = fractions)) %>%
#   ggplot(
#     aes(x = .data[[var1]], y = value)
#   ) +
#   geom_smooth() +
#   facet_wrap(vars(fraction))
# Not good enough
# "vdtochn" (big effect close to channels)
# "chelsa_bio17_1981_2010_10m" (probably just a proxy for geology)
# "flooded_depth_10m_mean" (skewed variable)
# "s2_count_max10_fuzzy" (mainly important for SOC)
# "chelsa_bio15_1981_2010_10m" (probably just a proxy for geology)
# "slope" (skewed variable)
# "valley_depth" (big effect at 0)
# "sin_aspect_radians" (no clear effect)
# "cos_aspect_radians" (no clear effect)
# "standardized_height" (ok, but the effect is not strong)
# "s2_geomedian_20180701_20180731_b8" (ok, but the effect is not strong)
# Good for plotting:
goodforplot <- c(
"filled_s1_baresoil_composite_vh_8_days",
"ogc_pi906",
"dhm2015_terraen_10m",
"filled_s2_geomedian_b11",
"filled_s2_geomedian_b3",
"filled_s1_baresoil_composite_vv_8_days",
"ogc_pi438",
"filled_s2_geomedian_b12",
"s2_geomedian_20180701_20180731_b4",
"s2_geomedian_20180408_20180515_b3"
)
for_plot_bare_soil <- c(
"filled_s1_baresoil_composite_vh_8_days",
"filled_s1_baresoil_composite_vv_8_days",
"filled_s2_geomedian_b3",
"filled_s2_geomedian_b11",
"filled_s2_geomedian_b12"
)
for_plot_other <- c(
"dhm2015_terraen_10m",
"ogc_pi438",
"ogc_pi906",
"s2_geomedian_20180408_20180515_b3",
"s2_geomedian_20180701_20180731_b4"
)
# Bare soil plot
# obs %>%
#   select(any_of(c(fractions, for_plot_bare_soil))) %>%
#   select(-fine_sand) %>%
#   tidyr::pivot_longer(
#     cols = any_of(fractions),
#     names_to = "fraction",
#     values_to = "value_y",
#     values_drop_na = TRUE
#   ) %>%
#   pivot_longer(
#     cols = any_of(for_plot_bare_soil),
#     names_to = "Covariate",
#     values_to = "value_x",
#     values_drop_na = TRUE
#   ) %>%
#   mutate(fraction = factor(fraction, levels = fractions)) %>%
#   ggplot(
#     aes(x = value_x, y = value_y)
#   ) +
#   geom_smooth() +
#   facet_grid(fraction ~ Covariate, scales = "free")
# Other variables
# obs %>%
#   select(any_of(c(fractions, for_plot_other))) %>%
#   select(-fine_sand) %>%
#   tidyr::pivot_longer(
#     cols = any_of(fractions),
#     names_to = "fraction",
#     values_to = "value_y",
#     values_drop_na = TRUE
#   ) %>%
#   pivot_longer(
#     cols = any_of(for_plot_other),
#     names_to = "Covariate",
#     values_to = "value_x",
#     values_drop_na = TRUE
#   ) %>%
#   mutate(fraction = factor(fraction, levels = fractions)) %>%
#   ggplot(
#     aes(x = value_x, y = value_y)
#   ) +
#   geom_smooth() +
#   facet_grid(fraction ~ Covariate, scales = "free")
# Get quantiles for covariates
cov_pts_q <- cov_pts %>%
lapply(
function(x) {
out <- stats::quantile(
x,
probs = seq(0.01, 0.99, 0.02),
# seq(0.05, 0.95, 0.1),
na.rm = TRUE
)
return(out)
}
) %>%
bind_cols()
# 3.1 Plots using models
# Load models
library(stringr)
library(pdp)
library(caret)
nboot_final <- 100
nboot_max <- 100
# nboot_max <- 100
nboot <- min(c(nboot_final, nboot_max))
boot_number_chr <- c(1:nboot) %>%
str_pad(
.,
nchar(nboot_final),
pad = "0"
)
boot_all_chr <- boot_number_chr %>%
paste0("boot_", .)
# pdp_outlist <- list()
#
# for (i in frac_ind_predict) {
#   print(fractions[i])
#   for (bootr in 1:nboot) {
#     print(bootr)
#     model_i <- models_boot_files[[i]][bootr] %>% readRDS()
#     names_model_i <- varImp(model_i)$importance %>% rownames()
#     for (k in 1:length(goodforplot)) {
#       if (goodforplot[k] %in% names_model_i) {
#         print(goodforplot[k])
#         pg_k <- cov_pts_q %>%
#           select(any_of(goodforplot[k]))
#         outgrid <- partial(
#           model_i,
#           pred.var = goodforplot[k],
#           pred.grid = pg_k
#         )
#         names(outgrid) <- c("x", "yhat")
#         outgrid$Fraction <- fractions[i]
#         outgrid$Covariate <- goodforplot[k]
#         pdp_outlist[[length(pdp_outlist) + 1]] <- outgrid
#       }
#     }
#   }
# }
#
# pdp_df_raw <- pdp_outlist %>%
#   bind_rows()
#
# saveRDS(
#   pdp_df_raw,
#   file = paste0(dir_results, "/pdp_df_raw.rds")
#   )
pdp_df_raw <- readRDS(paste0(dir_results, "/pdp_df_raw.rds"))
pdp_df <- pdp_df_raw %>%
group_by(Fraction, Covariate, x) %>%
summarise(
mean = mean(yhat),
low = stats::quantile(yhat, probs = 0.25),
high = stats::quantile(yhat, probs = 0.75)
)
frac_labels <- c(
"Clay",
"Silt",
"Fine sand",
"Coarse<br>sand",
"SOC",
"CaCO<sub>*3*</sub>"
)
bare_soil_labels <- c(
"S1 VH - Bare (dB)",  # "filled_s1_baresoil_composite_vh_8_days"
"S1 VV - Bare (dB)",  # "filled_s1_baresoil_composite_vv_8_days"
"S2 B3 - Bare",  # "filled_s2_geomedian_b3"
"S2 B11 - Bare",  # "filled_s2_geomedian_b11"
"S2 B12 - Bare"  # "filled_s2_geomedian_b12"
)
equal_breaks <- function(n = 3, s = 0.1, ...){
function(x){
d <- s * diff(range(x)) / (1 + 2*s)
seq = seq(min(x) + d, max(x) - d, length = n)
round(seq, -floor(log10(abs(seq[2] - seq[1]))))
}
}
equal_breaks2 <- function(n = 3, s = 0.1, ...) {
function(x){
diff(range(x))
lowest <- min(x) + diff(range(x))*s
highest <- max(x) - diff(range(x))*s
round1 <- -floor(log10(abs(highest - lowest)))
lowest2 <- ceiling(lowest*10^round1) / 10^round1
highest2 <- floor(highest*10^round1) / 10^round1
if (highest2 == lowest2) {
round1 <- round1 + 1
lowest2 <- ceiling(lowest*10^round1) / 10^round1
highest2 <- floor(highest*10^round1) / 10^round1
}
if (n > 2) {
seq1 <- seq(lowest2, highest2, length = n)
intermediates <- seq1[-c(1, length(seq1))]
intermediates <- round(intermediates, round1 + 1)
seq1 <- c(lowest2, intermediates, highest2)
} else {
seq1 <- c(lowest2, highest2)
}
seq1
}
}
equal_breaks2_test <- function(n = 3, s = 0.1, x) {
diff(range(x))
lowest <- min(x) + diff(range(x))*s
highest <- max(x) - diff(range(x))*s
round1 <- -floor(log10(abs(highest - lowest)))
lowest2 <- ceiling(lowest*10^round1) / 10^round1
highest2 <- floor(highest*10^round1) / 10^round1
if (highest2 == lowest2) {
round1 <- round1 + 1
lowest2 <- ceiling(lowest*10^round1) / 10^round1
highest2 <- floor(highest*10^round1) / 10^round1
}
if (n > 2) {
seq1 <- seq(lowest2, highest2, length = n)
intermediates <- seq1[-c(1, length(seq1))]
intermediates <- round(intermediates, round1 + 1)
seq1 <- c(lowest2, intermediates, highest2)
} else {
seq1 <- c(lowest2, highest2)
}
seq1
}
equal_breaks2_test(n = 4, s = 0, x = c(11, 150))
pdp_combo_i$x %>%
max() %>%
multiply_by(10^xlab_digits[i]) %>%
floor() %>%
divide_by(10^xlab_digits[i])
library(ggtext)
library(extrafont)
font_import()
tiff(
paste0(dir_results, "/pdp_texture_bare_test_", testn, ".tiff"),
width = 16,
height = 10,
units = "cm",
res = 600
)
pdp_df %>%
filter(Covariate %in% for_plot_bare_soil) %>%
mutate(
Fraction = factor(
Fraction,
levels = fractions,
labels = frac_labels
),
Covariate = factor(
Covariate,
levels = for_plot_bare_soil,
labels = bare_soil_labels
),
x = case_when(
Covariate %in% bare_soil_labels[1:2] ~ x / 100,
.default = x / 10^4
)
) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "cadetblue") +
geom_line(aes(x = x, y = high), colour = "cadetblue") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "cadetblue") +
geom_line() +
facet_grid(
Fraction ~ Covariate, scales = "free"
) +
theme(
text = element_text(family = "serif"),
axis.title.x = element_blank(),
axis.title.y = element_markdown(size = 9),
axis.text.x = element_markdown(size = 9),
axis.text.y = element_markdown(size = 9),
strip.text.y = element_markdown(size = 9, lineheight = 1),
strip.text.x = element_markdown(size = 9, lineheight = 1)
) +
ylab("ŷ (%)") +
scale_x_continuous(
expand = c(0, 0),
# n.breaks = 4,
breaks = equal_breaks2(n = 2, s = 0.17)
) +
scale_y_continuous(breaks = equal_breaks2(n = 2, s = 0.17))
try(dev.off())
tiff(
paste0(dir_results, "/pdp_texture_bare_test_", testn, ".tiff"),
width = 16,
height = 10,
units = "cm",
res = 600
)
pdp_df %>%
filter(Covariate %in% for_plot_bare_soil) %>%
mutate(
Fraction = factor(
Fraction,
levels = fractions,
labels = frac_labels
),
Covariate = factor(
Covariate,
levels = for_plot_bare_soil,
labels = bare_soil_labels
),
x = case_when(
Covariate %in% bare_soil_labels[1:2] ~ x / 100,
.default = x / 10^4
)
) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "cadetblue") +
geom_line(aes(x = x, y = high), colour = "cadetblue") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "cadetblue") +
geom_line() +
facet_grid(
Fraction ~ Covariate, scales = "free"
) +
theme(
text = element_text(family = "serif"),
axis.title.x = element_blank(),
axis.title.y = element_markdown(size = 9),
axis.text.x = element_markdown(size = 9),
axis.text.y = element_markdown(size = 9),
strip.text.y = element_markdown(size = 9, lineheight = 1),
strip.text.x = element_markdown(size = 9, lineheight = 1)
) +
ylab("ŷ (%)") +
scale_x_continuous(
expand = c(0, 0),
# n.breaks = 4,
breaks = equal_breaks2(n = 2, s = 0.1)
) +
scale_y_continuous(breaks = equal_breaks2(n = 2, s = 0.1))
try(dev.off())
classify_SOC <- function(SOC) {
out <- rep(0, length(SOC))
out[SOC > 12] <- 60
out[out == 0 & SOC > 6] <- 12
out[out == 0 & SOC > 3] <- 6
out[out == 0 & !is.na(SOM)] <- 3
out[out == 0] <- NA
return(out)
}
testdata <- runif(100)*100
classify_SOC(testdata)
classify_SOC <- function(SOC) {
out <- rep(0, length(SOC))
out[SOC > 12] <- 60
out[out == 0 & SOC > 6] <- 12
out[out == 0 & SOC > 3] <- 6
out[out == 0 & !is.na(SOC)] <- 3
out[out == 0] <- NA
return(out)
}
testdata <- runif(100)*100
classify_SOC(testdata)
testdata
plot(testdata, classify_SOC(testdata))
cbind(testdata, classify_SOC(testdata))
testdata <- runif(100)*100
testdata[1] <- na
seed(1)
testdata <- runif(100)*100
set.seed(1)
testdata <- runif(100)*100
testdata[1] <- NA
classify_SOC(testdata)
plot(testdata, classify_SOC(testdata))
cbind(testdata, classify_SOC(testdata))
?datatype
?writeChar
library(terra)
?writeRaster
