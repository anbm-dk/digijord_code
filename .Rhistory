geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_blank(aes(aes(x = x, y = low))) +
geom_blank(aes(aes(x = x, y = high))) +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_blank(aes(x = x, y = low)) +
geom_blank(aes(x = x, y = high)) +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_line(aes(x = x, y = low, colour = NA)) +
geom_blank(aes(x = x, y = high)) +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_line(aes(x = x, y = low, colour = rgb(1,1,1,0))) +
geom_blank(aes(x = x, y = high)) +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_line(aes(x = x, y = low, colour = rgb(1,1,1,alpha = 0))) +
geom_blank(aes(x = x, y = high)) +
facet_grid(Fraction ~ Covariate, scales = "free")
?rgb
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_line(aes(x = x, y = low, colour = rgb(1,1,1,alpha = 1))) +
geom_blank(aes(x = x, y = high)) +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_line(aes(x = x, y = low), alpha = 1) +
geom_blank(aes(x = x, y = high)) +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_line(aes(x = x, y = low), alpha = 0) +
geom_blank(aes(x = x, y = high)) +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_line(aes(x = x, y = low, alpha = 0)) +
geom_blank(aes(x = x, y = high)) +
facet_grid(Fraction ~ Covariate, scales = "free")
?geom_line
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_line(aes(x = x, y = low, colour = "grey70")) +
geom_blank(aes(x = x, y = high)) +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_blank(aes(x = x, y = high)) +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_line(aes(x = x, y = high), colour = "grey70") +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_line(aes(x = x, y = high), colour = "grey70") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_other) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_line(aes(x = x, y = high), colour = "grey70") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
facet_grid(Fraction ~ Covariate, scales = "free")
cov_pts_q <- cov_pts %>%
lapply(
function(x) {
out <- stats::quantile(
x,
probs = seq(0.01, 0.99, 0.02),
# seq(0.05, 0.95, 0.1),
na.rm = TRUE
)
return(out)
}
) %>%
bind_cols()
# 3.1 Inititial plot with a limited number of models
# Load models
library(stringr)
library(pdp)
library(caret)
nboot_final <- 100
nboot_max <- 100
# nboot_max <- 100
nboot <- min(c(nboot_final, nboot_max))
boot_all_chr <- c(1:nboot) %>%
str_pad(
.,
nchar(nboot_final),
pad = "0"
) %>%
paste0("boot_", .)
bootr <- 1
pdp_outlist <- list()
for (i in frac_ind_predict) {
print(fractions[i])
for (bootr in 1:nboot) {
print(bootr)
model_i <- models_boot_files[[i]][bootr] %>% readRDS()
names_model_i <- varImp(model_i)$importance %>% rownames()
for (k in 1:length(goodforplot)) {
if (goodforplot[k] %in% names_model_i) {
print(goodforplot[k])
pg_k <- cov_pts_q %>%
select(any_of(goodforplot[k]))
outgrid <- partial(
model_i,
pred.var = goodforplot[k],
pred.grid = pg_k
)
names(outgrid) <- c("x", "yhat")
outgrid$Fraction <- fractions[i]
outgrid$Covariate <- goodforplot[k]
pdp_outlist[[length(pdp_outlist) + 1]] <- outgrid
}
}
}
}
pdp_df <- pdp_outlist %>%
bind_rows() %>%
group_by(Fraction, Covariate, x) %>%
summarise(
mean = mean(yhat),
low = stats::quantile(yhat, probs = 0.05),
high = stats::quantile(yhat, probs = 0.95)
)
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_line(aes(x = x, y = high), colour = "grey70") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_other) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_line(aes(x = x, y = high), colour = "grey70") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df <- pdp_outlist %>%
bind_rows() %>%
group_by(Fraction, Covariate, x) %>%
summarise(
mean = mean(yhat),
low = stats::quantile(yhat, probs = 0.25),
high = stats::quantile(yhat, probs = 0.75)
)
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_line(aes(x = x, y = high), colour = "grey70") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_other) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_line(aes(x = x, y = high), colour = "grey70") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_bare_soil) %>%
mutate(Fraction = factor(Fraction, levels = fractions)) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_line(aes(x = x, y = high), colour = "grey70") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_df %>%
bind_rows() %>%
filter(Covariate %in% for_plot_other) %>%
mutate(Fraction = factor(Fraction, levels = fractions)) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_line(aes(x = x, y = high), colour = "grey70") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
facet_grid(Fraction ~ Covariate, scales = "free")
pdp_outlist %>%
bind_rows()
pdp_df_raw <- pdp_outlist %>%
bind_rows()
saveRDS(
pdp_df_raw,
file = paste0(dir_results, "/pdp_df_raw.rds")
)
readRDS(paste0(dir_results, "/pdp_df_raw.rds"))
tiff(
paste0(dir_results, "/pdp_texture_bare_test_", testn, ".tiff"),
width = 16,
height = 10,
units = "cm",
res = 600
)
pdp_df %>%
filter(Covariate %in% for_plot_bare_soil) %>%
mutate(Fraction = factor(Fraction, levels = fractions)) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_line(aes(x = x, y = high), colour = "grey70") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
facet_grid(Fraction ~ Covariate, scales = "free")
try(dev.off())
tiff(
paste0(dir_results, "/pdp_texture_other_test_", testn, ".tiff"),
width = 16,
height = 10,
units = "cm",
res = 600
)
pdp_df %>%
filter(Covariate %in% for_plot_other) %>%
mutate(Fraction = factor(Fraction, levels = fractions)) %>%
ggplot(
aes(x = x, y = mean)
) +
geom_line(aes(x = x, y = low), colour = "grey70") +
geom_line(aes(x = x, y = high), colour = "grey70") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "grey70") +
geom_line() +
facet_grid(Fraction ~ Covariate, scales = "free")
try(dev.off())
var1 <- "s2_geomedian_20180701_20180731_b8"
# var1 <- candidates_top[var_i]
# var1 <- candidates_other[var_i]
obs %>%
select(any_of(c(fractions, var1))) %>%
tidyr::pivot_longer(
cols = any_of(fractions),
names_to = "fraction",
values_to = "value",
values_drop_na = TRUE
) %>%
mutate(fraction = factor(fraction, levels = fractions)) %>%
ggplot(
aes(x = .data[[var1]], y = value)
) +
geom_smooth() +
facet_wrap(vars(fraction))
library(terra)
library(magrittr)
library(tools)
library(dplyr)
library(caret)
library(tibble)
library(tidyr)
library(xgboost)
library(stringr)
library(ggplot2)
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
testn <- 14
mycrs <- "EPSG:25832"
dir_results <- dir_dat %>%
paste0(., "/results_test_", testn, "/")
dir_boot <- dir_results %>%
paste0(., "/bootstrap/")
dir_boot_models <- dir_boot %>%
paste0(., "/models/")
# Load observations used in models
obs_texture <- paste0(dir_results, "/observations_texture.rds") %>%
readRDS()
# Load mean bootstrap predictions
boot_predictions_mean <- dir_boot %>%
paste0(., "/models_boot_predictions_mean.rds") %>%
readRDS()
# Load model weights
fractions_alt  <- c("clay", "silt", "fine_sand", "coarse_sand", "SOC", "CaCO3")
fractions      <- fractions_alt
models_weights <- list()
models_indices <- list()
for (i in 1:length(fractions)) {
frac <- fractions[i]
models_weights[[i]] <- dir_results %>%
paste0(., "/models_weights_", frac, ".rds") %>%
readRDS()
models_indices[[i]] <- dir_results %>%
paste0(., "/models_indices_", frac, ".csv") %>%
readRDS()
}
boot_predictions_mean
boot_predictions_mean <- dir_boot %>%
paste0(., "/models_boot_predictions_mean.rds") %>%
readRDS()
boot_predictions_mean %>%
as.data.frame()
boot_predictions_mean %>%
as.data.frame() %>%
pivot_longer(
cols = everything()
)
boot_predictions_mean %>%
as.data.frame() %>%
pivot_longer(
cols = everything()
) %>%
mutate(
name = paste0(name, "_predicted")
)
boot_predictions_mean %>%
as.data.frame() %>%
pivot_longer(cols = everything()) %>%
mutate(name = paste0(name, "_predicted")) %>%
pivot_wider()
boot_predictions_mean %>%
as.data.frame() %>%
mutate(rown = row_number())
boot_predictions_mean %>%
as.data.frame() %>%
mutate(rown = row_number()) %>%
pivot_longer(cols = everything())
boot_predictions_mean %>%
as.data.frame() %>%
mutate(rown = row_number()) %>%
pivot_longer(cols = !rown)
boot_predictions_mean %>%
as.data.frame() %>%
mutate(rown = row_number()) %>%
pivot_longer(cols = !rown) %>%
mutate(name = paste0(name, "_predicted")) %>%
pivot_wider()
predictions_df <- boot_predictions_mean %>%
as.data.frame() %>%
mutate(rown = row_number()) %>%
pivot_longer(cols = !rown) %>%
mutate(name = paste0(name, "_predicted")) %>%
pivot_wider() %>%
select(-rown)
obs_texture
obs_texture %>% names()
columns <- c(
"ID_new",	"db", "ID_old",	"date", "UTMX",	"UTMY", "upper", "lower", "clay",
"silt", "fine_sand",	"coarse_sand", "SOC",	"CaCO3", "SOM_removed",
"PROFILNR",	"year", "fold"
)
obs_texture %>%
select(any_of(columns))
columns <- c(
"ID_new",	"db", "ID_old",	"date", "UTMX",	"UTMY", "upper", "lower", "clay",
"silt", "fine_sand",	"coarse_sand", "SOC",	"CaCO3", "SOM_removed",
"PROFILNR",	"year", "fold", "imputed"
)
obs_texture %>%
select(any_of(columns))
fractions_alt  <- c("clay", "silt", "fine_sand", "coarse_sand", "SOC", "CaCO3")
fractions      <- fractions_alt
columns <- c(
"ID_new",	"db", "ID_old",	"date", "UTMX",	"UTMY", "upper", "lower", "clay",
"silt", "fine_sand",	"coarse_sand", "SOC",	"CaCO3", "SOM_removed",
"PROFILNR",	"year", "fold", "imputed"
)
obs_texture %>%
select(any_of(columns)) %>%
rename_with(~ str_c(., "observed"), .cols = any_of(fractions))
predictions_df
obs_texture %>%
select(any_of(columns)) %>%
rename_with(~ str_c(., "_observed"), .cols = any_of(fractions))
texture_obs_pred <- obs_texture %>%
select(any_of(columns)) %>%
rename_with(~ str_c(., "_observed"), .cols = any_of(fractions)) %>%
bind_cols(., predictions_df)
texture_obs_pred
texture_obs_pred %>%
filter(is.finite(PROFILNR))
texture_obs_pred_profiles <- texture_obs_pred %>%
filter(is.finite(PROFILNR))
?write.table
write.table(
texture_obs_pred,
paste0(dir_results, "/texture_obs_pred.csv"),
sep = ";",
row.names = FALSE
)
write.table(
texture_obs_pred_profiles,
paste0(dir_results, "/texture_obs_pred_profiles.csv"),
sep = ";",
row.names = FALSE
)
