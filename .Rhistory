scales = "free"
) +
geom_smooth(
se = FALSE,
color = "red"
) +
labs(
x = "Covariate value",
y = "Observation"
) +
scale_x_continuous(
n.breaks = 3,
labels = label_number(scale_cut = cut_short_scale())
) +
scale_y_continuous(n.breaks = 3)
tiff(
paste0(dir_results, "/covariate_effects_test", testn, ".tiff"),
width = 15,
height = 10,
units = "cm",
res = 300
)
obs_top %>%
select(all_of(figure_cols)) %>%
# sample_frac(0.1) %>%
mutate(
s1_baresoil_composite_vh_8_days = ifelse(
s1_baresoil_composite_vh_8_days == 0 | s1_baresoil_composite_vh_8_days < -3000,
NA,
s1_baresoil_composite_vh_8_days
),
s2_geomedian_b3 = ifelse(
s2_geomedian_b3 > 2000,
NA,
s2_geomedian_b3
),
logCaCO3 = ifelse(
is.finite(logCaCO3),
logCaCO3,
NA
),
logSOC = ifelse(
logSOC > -2.5,
logSOC,
NA
),
clay = ifelse(
clay < 30,
clay,
NA
),
silt = ifelse(
silt < 30,
silt,
NA
)
) %>%
rename(
DEM = dhm2015_terraen_10m,
UTMX = ogc_lite_pi0000,
S1_bare_vh = s1_baresoil_composite_vh_8_days,
S2_summer_b7 = s2_geomedian_20180501_20180731_b7,
S2_bare_b3 = s2_geomedian_b3
) %>%
pivot_longer(
all_of(short_names),
names_to = "Covariate",
values_to = "x_value"
) %>%
pivot_longer(
all_of(fractions),
names_to = "Fraction",
values_to = "y_value",
) %>%
ggplot(
aes(
x = x_value,
y = y_value
)
) +
geom_point(alpha = .01, shape = 16) +
facet_grid(
factor(Fraction, levels = fractions) ~ Covariate,
scales = "free"
) +
geom_smooth(
se = FALSE,
color = "red"
) +
labs(
x = "Covariate value",
y = "Observation"
) +
scale_x_continuous(
n.breaks = 3,
labels = label_number(scale_cut = cut_short_scale())
) +
scale_y_continuous(n.breaks = 3)
dev.off()
dev.off()
obs_top %>%
select(all_of(figure_cols)) %>%
sample_frac(0.1) %>%
mutate(
s1_baresoil_composite_vh_8_days = ifelse(
s1_baresoil_composite_vh_8_days == 0 | s1_baresoil_composite_vh_8_days < -3000,
NA,
s1_baresoil_composite_vh_8_days
),
s2_geomedian_b3 = ifelse(
s2_geomedian_b3 > 2000,
NA,
s2_geomedian_b3
),
logCaCO3 = ifelse(
is.finite(logCaCO3),
logCaCO3,
NA
),
logSOC = ifelse(
logSOC > -2.5,
logSOC,
NA
),
clay = ifelse(
clay < 30,
clay,
NA
),
silt = ifelse(
silt < 30,
silt,
NA
)
) %>%
rename(
DEM = dhm2015_terraen_10m,
UTMX = ogc_lite_pi0000,
S1_bare_vh = s1_baresoil_composite_vh_8_days,
S2_summer_b7 = s2_geomedian_20180501_20180731_b7,
S2_bare_b3 = s2_geomedian_b3
) %>%
pivot_longer(
all_of(short_names),
names_to = "Covariate",
values_to = "x_value"
) %>%
pivot_longer(
all_of(fractions),
names_to = "Fraction",
values_to = "y_value",
) %>%
ggplot(
aes(
x = x_value,
y = y_value
)
) +
geom_point(alpha = .01, shape = 16) +
facet_grid(
factor(Fraction, levels = fractions) ~ Covariate,
scales = "free"
) +
geom_smooth(
se = FALSE,
color = "red"
) +
labs(
x = "Covariate value",
y = "Observation (%)"
) +
scale_x_continuous(
n.breaks = 3,
labels = label_number(scale_cut = cut_short_scale())
) +
scale_y_continuous(n.breaks = 3) +
theme(strip.text.y.right = element_text(angle = 0))
tiff(
paste0(dir_results, "/covariate_effects_test", testn, ".tiff"),
width = 15,
height = 10,
units = "cm",
res = 300
)
obs_top %>%
select(all_of(figure_cols)) %>%
# sample_frac(0.1) %>%
mutate(
s1_baresoil_composite_vh_8_days = ifelse(
s1_baresoil_composite_vh_8_days == 0 | s1_baresoil_composite_vh_8_days < -3000,
NA,
s1_baresoil_composite_vh_8_days
),
s2_geomedian_b3 = ifelse(
s2_geomedian_b3 > 2000,
NA,
s2_geomedian_b3
),
logCaCO3 = ifelse(
is.finite(logCaCO3),
logCaCO3,
NA
),
logSOC = ifelse(
logSOC > -2.5,
logSOC,
NA
),
clay = ifelse(
clay < 30,
clay,
NA
),
silt = ifelse(
silt < 30,
silt,
NA
)
) %>%
rename(
DEM = dhm2015_terraen_10m,
UTMX = ogc_lite_pi0000,
S1_bare_vh = s1_baresoil_composite_vh_8_days,
S2_summer_b7 = s2_geomedian_20180501_20180731_b7,
S2_bare_b3 = s2_geomedian_b3
) %>%
pivot_longer(
all_of(short_names),
names_to = "Covariate",
values_to = "x_value"
) %>%
pivot_longer(
all_of(fractions),
names_to = "Fraction",
values_to = "y_value",
) %>%
ggplot(
aes(
x = x_value,
y = y_value
)
) +
geom_point(alpha = .01, shape = 16) +
facet_grid(
factor(Fraction, levels = fractions) ~ Covariate,
scales = "free"
) +
geom_smooth(
se = FALSE,
color = "red"
) +
labs(
x = "Covariate value",
y = "Observation (%)"
) +
scale_x_continuous(
n.breaks = 3,
labels = label_number(scale_cut = cut_short_scale())
) +
scale_y_continuous(n.breaks = 3) +
theme(strip.text.y.right = element_text(angle = 0))
dev.off()
dev.off()
tiff(
paste0(dir_results, "/covariate_effects_test", testn, ".tiff"),
width = 16,
height = 10,
units = "cm",
res = 300
)
obs_top %>%
select(all_of(figure_cols)) %>%
# sample_frac(0.1) %>%
mutate(
s1_baresoil_composite_vh_8_days = ifelse(
s1_baresoil_composite_vh_8_days == 0 | s1_baresoil_composite_vh_8_days < -3000,
NA,
s1_baresoil_composite_vh_8_days
),
s2_geomedian_b3 = ifelse(
s2_geomedian_b3 > 2000,
NA,
s2_geomedian_b3
),
logCaCO3 = ifelse(
is.finite(logCaCO3),
logCaCO3,
NA
),
logSOC = ifelse(
logSOC > -2.5,
logSOC,
NA
),
clay = ifelse(
clay < 30,
clay,
NA
),
silt = ifelse(
silt < 30,
silt,
NA
)
) %>%
rename(
DEM = dhm2015_terraen_10m,
UTMX = ogc_lite_pi0000,
S1_bare_vh = s1_baresoil_composite_vh_8_days,
S2_summer_b7 = s2_geomedian_20180501_20180731_b7,
S2_bare_b3 = s2_geomedian_b3
) %>%
pivot_longer(
all_of(short_names),
names_to = "Covariate",
values_to = "x_value"
) %>%
pivot_longer(
all_of(fractions),
names_to = "Fraction",
values_to = "y_value",
) %>%
ggplot(
aes(
x = x_value,
y = y_value
)
) +
geom_point(alpha = .01, shape = 16) +
facet_grid(
factor(Fraction, levels = fractions) ~ Covariate,
scales = "free"
) +
geom_smooth(
se = FALSE,
color = "red"
) +
labs(
x = "Covariate value",
y = "Observation (%)"
) +
scale_x_continuous(
n.breaks = 3,
labels = label_number(scale_cut = cut_short_scale())
) +
scale_y_continuous(n.breaks = 3) +
theme(strip.text.y.right = element_text(angle = 0))
dev.off()
dev.off()
library(Cubist)
library(terra)
library(magrittr)
library(tools)
library(dplyr)
library(caret)
library(tibble)
library(tidyr)
library(doParallel)
library(spatstat)  # weights
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
testn <- 5
mycrs <- "EPSG:25832"
# 2: Load observations
dir_obs_proc <- dir_dat %>%
paste0(., "/observations/processed/")
dsc <- dir_obs_proc %>%
paste0(., "dsc.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SEGES <- dir_obs_proc %>%
paste0(., "SEGES.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SINKS <- dir_obs_proc %>%
paste0(., "SINKS.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
# 3: Load folds
dir_folds <- dir_dat %>%
paste0(., "/folds/")
dsc_folds <- dir_folds %>%
paste0(., "dsc_folds.csv") %>%
read.table(
header = TRUE,
sep = ";",
)
SEGES_folds <- dir_folds %>%
paste0(., "SEGES_folds.csv") %>%
read.table(
header = TRUE,
sep = ";",
)
SINKS_folds <- dir_folds %>%
paste0(., "SINKS_folds.csv") %>%
read.table(
header = TRUE,
sep = ";",
)
# 4: Load covariates
cov_dir <- dir_dat %>% paste0(., "/covariates")
cov_cats <- dir_code %>%
paste0(., "/cov_categories_20230202.csv") %>%
read.table(
sep = ";",
header = TRUE
)
cov_files <- cov_dir %>% list.files
cov_names <- cov_files %>% tools::file_path_sans_ext()
cov_names %>%
write.table(
paste0("cov_names_", Sys.Date(), ".csv")
)
cov_names[!cov_names %in% cov_cats$name]
cov <- paste0(cov_dir, "/", cov_files) %>%
rast()
names(cov) <- cov_names
# 5: Load extracted covariates
dir_extr <- dir_dat %>%
paste0(., "/extracts/")
dsc_extr <- dir_extr %>%
paste0(., "dsc_extr.csv") %>%
read.table(
header = TRUE,
sep = ";",
)
SEGES_extr <- dir_extr %>%
paste0(., "SEGES_extr.csv") %>%
read.table(
header = TRUE,
sep = ";",
)
SINKS_extr <- dir_extr %>%
paste0(., "SINKS_extr.csv") %>%
read.table(
header = TRUE,
sep = ";",
)
# 6: Merge data and transform the target variables
obs <- list(dsc, SEGES, SINKS) %>%
vect() %>%
values() %>%
mutate(
logSOC = log(SOC),
logCaCO3 = log(CaCO3)
)
fractions <- c("clay", "silt", "fine_sand", "coarse_sand", "logSOC", "logCaCO3")
fraction_names <- c(
"Clay", "Silt", "Fine sand", "Coarse sand", "SOC", "CaCO3"
)
bounds_lower <- c(0, 0, 0, 0, NA, NA)
bounds_upper <- c(100, 100, 100, 100, log(100), log(100))
# 7: Make training data
folds <- bind_rows(
dsc_folds,
SEGES_folds,
SINKS_folds
)
names(folds) <- "fold"
extr <- bind_rows(
dsc_extr,
SEGES_extr,
SINKS_extr
)
obs <- cbind(obs, extr, folds)
obs_top <- obs %>%
filter(upper == 0)
names(obs_top)
obs_top_v <- obs_top %>% vect(geom = c("UTMX", "UTMY"))
plot(obs_top_v)
plot(obs_top_v, "clay")
plot(obs_top_v, "logSOC")
?`plot,SpatVector,numeric-method`
plot(obs_top_v, "clay", breaks = 5, breakby = "cases")
library(viridisLite)
plot(obs_top_v, "clay", breaks = 5, breakby = "cases", col = cividis(5))
dir_results <- dir_dat %>%
paste0(., "/results_test_", testn, "/") %T>%
dir.create()
tiff(
paste0(dir_results, "/obs_map_test", testn, ".tiff"),
width = 15,
height = 10,
units = "cm",
res = 300
)
plot(obs_top_v, "clay", breaks = 5, breakby = "cases", col = cividis(5))
dev.off()
dev.off()
plot(obs_top_v, "clay", breaks = 5, breakby = "cases", col = cividis(5))
