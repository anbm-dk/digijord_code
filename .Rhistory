) %>%
ungroup() %>%
mutate(
tsum = case_when(
tsum == 0 ~ NA
.default = tsum
forests_all <- bind_rows(forests_tax2, forests_dsc2) %>%
mutate(
UTMX = UTMØ,
UTMY = UTMN,
SOM_removed = 0,
SOC = Humus*0.586
) %>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ungroup() %>%
mutate(
tsum = case_when(
tsum == 0 ~ NA,
.default = tsum
)
)
forests_all %>%
ggplot(aes(x = SOC, y = tsum)) + geom_point()
forests_all %>%
mutate(
clay = Ler * 100 / tsum,
silt = Silt * 100 / tsum,
fine_sand = Finsand * 100 / tsum,
coarse_sand = Grovsand * 100 / tsum
) %>% as.data.frame()
forests_all %>%
mutate(
clay = Ler * 100 / tsum,
silt = Silt * 100 / tsum,
fine_sand = Finsand * 100 / tsum,
coarse_sand = Grovsand * 100 / tsum
) %>% slice_sample(n = 20)%>% as.data.frame()
forests_all %>%
mutate(
clay = Ler * 100 / tsum,
silt = Silt * 100 / tsum,
fine_sand = Finsand * 100 / tsum,
coarse_sand = Grovsand * 100 / tsum
) %>% slice_sample(n = 20)%>% as.data.frame()
forests_all <- bind_rows(forests_tax2, forests_dsc2) %>%
mutate(
UTMX = UTMØ,
UTMY = UTMN,
SOM_removed = 0,
SOC = Humus*0.586
) %>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ungroup() %>%
mutate(
tsum = case_when(
tsum == 0 ~ NA,
.default = tsum
),
clay = Ler * 100 / tsum,
silt = Silt * 100 / tsum,
fine_sand = Finsand * 100 / tsum,
coarse_sand = Grovsand * 100 / tsum
) %>%
select(any_of(mycolnames))
forests_all
forests_all %>% as.data.frame()
write.table(
forests_all,
paste0(dir_obs_proc, "forest_samples.csv"),
row.names = FALSE,
sep = ";"
)
dir_obs_proc <- dir_dat %>%
paste0(., "/observations/processed/") %T>%
dir.create()
write.table(
forests_all,
paste0(dir_obs_proc, "forest_samples.csv"),
row.names = FALSE,
sep = ";"
)
library(terra)
library(magrittr)
library(exactextractr)
library(sf)
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
mycrs <- "EPSG:25832"
# 1 Load observations
dir_obs_proc <- dir_dat %>%
paste0(., "/observations/processed/")
dsc <- dir_obs_proc %>%
paste0(., "dsc.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SEGES <- dir_obs_proc %>%
paste0(., "SEGES.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SINKS <- dir_obs_proc %>%
paste0(., "SINKS.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
profiles_shp <- dir_dat %>%
paste0(
.,
"/observations/profiles/Profiles_coordinates_new/Profiles_coordinates_new.shp"
) %>%
vect()
forest_samples <- dir_obs_proc %>%
paste0(., "forest_samples.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
plot(forest_samples, "clay")
plot(forest_samples, "SOC")
# 03: Extract covariates
library(terra)
library(magrittr)
library(exactextractr)
library(sf)
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
mycrs <- "EPSG:25832"
# 1 Load observations
dir_obs_proc <- dir_dat %>%
paste0(., "/observations/processed/")
dsc <- dir_obs_proc %>%
paste0(., "dsc.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SEGES <- dir_obs_proc %>%
paste0(., "SEGES.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SINKS <- dir_obs_proc %>%
paste0(., "SINKS.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
profiles_shp <- dir_dat %>%
paste0(
.,
"/observations/profiles/Profiles_coordinates_new/Profiles_coordinates_new.shp"
) %>%
vect()
forest_samples <- dir_obs_proc %>%
paste0(., "forest_samples.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
# 2 Load covariates
cov_dir <- dir_dat %>% paste0(., "/covariates")
cov_files <- cov_dir %>% list.files()
cov_names <- cov_files %>% tools::file_path_sans_ext()
cov <- paste0(cov_dir, "/", cov_files) %>%
rast()
names(cov) <- cov_names
crs(cov) <- mycrs
# 3 Create buffers (40 m = ~ 0.5 ha)
buffer_dsc <- terra::buffer(
dsc,
width = 40
) %>%
st_as_sf()
buffer_SEGES <- terra::buffer(
SEGES,
width = 40
) %>%
st_as_sf()
# 4 Extract
dsc_extr <- terra::extract(
x = cov,
y = dsc,
ID = FALSE,
)
# buffer_dsc_extr <- exact_extract(
#     x = cov,
#     y = buffer_dsc,
#     fun = "mean",
#     progress = TRUE
#   )
# names(buffer_dsc_extr) <- names(cov)
SEGES_extr <- terra::extract(
x = cov,
y = SEGES,
ID = FALSE,
)
# buffer_SEGES_extr <- exact_extract(
#   x = cov,
#   y = buffer_SEGES,
#   fun = "mean",
#   progress = TRUE
# )
# names(buffer_SEGES_extr) <- names(cov)
SINKS_extr <- terra::extract(
x = cov,
y = SINKS,
ID = FALSE,
)
profiles_extr <- terra::extract(
x = cov,
y = profiles_shp,
ID = FALSE,
)
profiles_extr$PROFILNR <- profiles_shp$PROFILNR
forests_extr <- terra::extract(
x = cov,
y = forest_samples,
ID = FALSE,
)
# 5 Write to csv
dir_extr <- dir_dat %>%
paste0(., "/extracts/")
write.table(
dsc_extr,
paste0(dir_extr, "dsc_extr.csv"),
row.names = FALSE,
sep = ";"
)
# write.table(
#   buffer_dsc_extr,
#   paste0(dir_extr, "buffer_dsc_extr.csv"),
#   row.names = FALSE,
#   sep = ";"
# )
write.table(
SEGES_extr,
paste0(dir_extr, "SEGES_extr.csv"),
row.names = FALSE,
sep = ";"
)
# write.table(
#   buffer_SEGES_extr,
#   paste0(dir_extr, "buffer_SEGES_extr.csv"),
#   row.names = FALSE,
#   sep = ";"
# )
write.table(
SINKS_extr,
paste0(dir_extr, "SINKS_extr.csv"),
row.names = FALSE,
sep = ";"
)
write.table(
profiles_extr,
paste0(dir_extr, "profiles_extr.csv"),
row.names = FALSE,
sep = ";"
)
write.table(
forests_extr,
paste0(dir_extr, "forests_extr.csv"),
row.names = FALSE,
sep = ";"
)
# Save as RDS
saveRDS(
dsc_extr,
paste0(dir_extr, "dsc_extr.rds")
)
saveRDS(
SEGES_extr,
paste0(dir_extr, "SEGES_extr.rds")
)
saveRDS(
SINKS_extr,
paste0(dir_extr, "SINKS_extr.rds")
)
saveRDS(
profiles_extr,
paste0(dir_extr, "profiles_extr.rds")
)
saveRDS(
forests_extr,
paste0(dir_extr, "forests_extr.rds")
)
# END
# 04: Create folds
library(terra)
library(magrittr)
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
mycrs <- "EPSG:25832"
# 1 Load observations
dir_obs_proc <- dir_dat %>%
paste0(., "/observations/processed/")
dsc <- dir_obs_proc %>%
paste0(., "dsc.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SEGES <- dir_obs_proc %>%
paste0(., "SEGES.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SINKS <- dir_obs_proc %>%
paste0(., "SINKS.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
profiles_shp <- dir_dat %>%
paste0(
.,
"/observations/profiles/Profiles_coordinates_new/Profiles_coordinates_new.shp"
) %>%
vect()
forest_samples <- dir_obs_proc %>%
paste0(., "forest_samples.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
# 2 Load and aggregate DEM
cov_dir <- dir_dat %>% paste0(., "/covariates/")
DEM_10m <- cov_dir %>%
paste0(., "/dhm2015_terraen_10m.tif") %>%
rast()
fun_agg <- function(x) {
out <- sum(!is.na(x)) == 0
return(out)
}
dir_folds <- dir_dat %>%
paste0(., "/folds/") %T>%
dir.create()
# file_dem_mask_100m <- paste0(dir_folds, "/dem_mask_100m.tif")
#
# terra::aggregate(
#   DEM_10m,
#   10,
#   fun = fun_agg,
#   cores = 19,
#   filename = file_dem_mask_100m
# )
#
# dem_mask_100m <- rast(file_dem_mask_100m)
#
# dem_mask_100m2 <- ifel(dem_mask_100m == 1, NA, 1)
file_dem_mask_100m_2 <- paste0(dir_folds, "/dem_mask_100m_2.tif")
# writeRaster(
#   dem_mask_100m2,
#   filename = file_dem_mask_100m_2,
#   overwrite = TRUE,
#   datatype = "INT1U"
#   )
dem_mask_100m2 <- rast(file_dem_mask_100m_2)
plot(dem_mask_100m2)
# 3: Calculate 10 folds
set.seed(1)
# folds_10_100m <- app(
#   dem_mask_100m2,
#   function(x) {
#     out <- x*0 + sample.int(10, 1)
#     return(out)
#   },
#   cores = 2
# )
file_folds_10_100m <- paste0(dir_folds, "/folds_10_100m.tif")
# writeRaster(
#   folds_10_100m,
#   filename = file_folds_10_100m,
#   overwrite = TRUE,
#   datatype = "INT1U"
#   )
folds_10_100m <- rast(file_folds_10_100m)
# 4 Extract
dsc_folds <- terra::extract(
x = folds_10_100m,
y = dsc,
ID = FALSE,
)
SEGES_folds <- terra::extract(
x = folds_10_100m,
y = SEGES,
ID = FALSE,
)
SINKS_folds <- terra::extract(
x = folds_10_100m,
y = SINKS,
ID = FALSE,
)
profiles_folds <- terra::extract(
x = folds_10_100m,
y = profiles_shp,
ID = FALSE,
)
profiles_folds$PROFILNR <- profiles_shp$PROFILNR
forests_folds <- terra::extract(
x = folds_10_100m,
y = forest_samples,
ID = FALSE,
)
# 5 Write to file
write.table(
dsc_folds,
paste0(dir_folds, "/dsc_folds.csv"),
row.names = FALSE,
sep = ";"
)
write.table(
SEGES_folds,
paste0(dir_folds, "/SEGES_folds.csv"),
row.names = FALSE,
sep = ";"
)
write.table(
SINKS_folds,
paste0(dir_folds, "/SINKS_folds.csv"),
row.names = FALSE,
sep = ";"
)
write.table(
profiles_folds,
paste0(dir_folds, "/profiles_folds.csv"),
row.names = FALSE,
sep = ";"
)
write.table(
forests_folds,
paste0(dir_folds, "/forest_folds.csv"),
row.names = FALSE,
sep = ";"
)
# END
