breaks_j_chr <- breaks_chr[j:(j + 1)]
dir_pred_tiles_100 <- dir_pred_tiles %>%
paste0(
., "/tex_100_",
breaks_j_chr[1], "_", breaks_j_chr[2], "_cm/"
)
dir_pred_tiles_JB <- dir_pred_tiles %>%
paste0(., "/JB_", breaks_j_chr[1], "_", breaks_j_chr[2], "_cm/") %T>%
dir.create(showWarnings = FALSE, recursive = TRUE)
showConnections()
cl <- makeCluster(numCores)
clusterEvalQ(
cl,
{
library(terra)
library(magrittr)
library(dplyr)
library(tools)
}
)
clusterExport(
cl,
c(
"breaks_j_chr",
"subdir_tiles",
"dir_dat",
"dir_pred_tiles",
"dir_pred_tiles_100",
"fraction_names_underscore",
"dir_pred_tiles_JB",
"classify_soil_JB"
)
)
parSapplyLB(
cl,
1:length(subdir_tiles),
function(x) {
tmpfolder <- paste0(dir_dat, "/Temp/")
terraOptions(memfrac = 0.02, tempdir = tmpfolder)
tilename_x <- basename(subdir_tiles[x])
rs_100 <- dir_pred_tiles_100 %>%
paste0(
., "/tex100_", tilename_x,
breaks_j_chr[1], "_", breaks_j_chr[2], "_cm.tif"
) %>%
rast()
tile_soc <- dir_pred_tiles %>%
paste0(
., "/", fraction_names_underscore[5], "_",
breaks_j_chr[1], "_", breaks_j_chr[2], "_cm/"
) %>%
list.files(full.names = TRUE) %>%
.[x] %>%
rast()
tile_CaCO3 <- dir_pred_tiles %>%
paste0(
., "/", fraction_names_underscore[6], "_",
breaks_j_chr[1], "_", breaks_j_chr[2], "_cm/"
) %>%
list.files(full.names = TRUE) %>%
.[x] %>%
rast()
rs_s2 <- c(subset(rs_100, 1:3), tile_soc, tile_CaCO3)
names(rs_s2) <- c("clay", "silt", "sand_f", "SOM", "CaCO3")
outname_x <- dir_pred_tiles_JB %>%
paste0(
., "/JB_",
breaks_j_chr[1], "_", breaks_j_chr[2], "_cm_",
tilename_x, ".tif"
)
lapp(
rs_s2,
classify_soil_JB,
SOM_factor = 1 / 0.568,
filename = outname_x,
overwrite = TRUE,
wopt = list(
datatype = "INT1U",
NAflag = 13
)
)
return(NULL)
}
)
stopCluster(cl)
foreach::registerDoSEQ()
rm(cl)
outtiles_JB <- dir_pred_tiles_JB %>%
list.files(full.names = TRUE) %>%
sprc()
merge(
outtiles_JB,
filename = paste0(
dir_pred_all, "/JB_",
breaks_j_chr[1], "_", breaks_j_chr[2], "_cm.tif"
),
overwrite = TRUE,
gdal = "TILED=YES",
datatype = "INT1U",
NAflag = 13,
names = paste0(
"JB_",
breaks_j_chr[1], "_", breaks_j_chr[2], "_cm"
)
)
}
library(terra)
library(magrittr)
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
mycrs <- "EPSG:25832"
# 1 Load observations
dir_obs_proc <- dir_dat %>%
paste0(., "/observations/processed/")
dsc <- dir_obs_proc %>%
paste0(., "dsc.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SEGES <- dir_obs_proc %>%
paste0(., "SEGES.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
SINKS <- dir_obs_proc %>%
paste0(., "SINKS.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
profiles_shp <- dir_dat %>%
paste0(
.,
"/observations/profiles/Profiles_coordinates_new/Profiles_coordinates_new.shp"
) %>%
vect()
forest_samples <- dir_obs_proc %>%
paste0(., "forest_samples.csv") %>%
read.table(
header = TRUE,
sep = ";",
) %>%
vect(
geom = c("UTMX", "UTMY"),
crs = mycrs,
keepgeom = TRUE
)
# 2 Load and aggregate DEM
cov_dir <- dir_dat %>% paste0(., "/covariates/")
DEM_10m <- cov_dir %>%
paste0(., "/dhm2015_terraen_10m.tif") %>%
rast()
fun_agg <- function(x) {
out <- sum(!is.na(x)) == 0
return(out)
}
dir_folds <- dir_dat %>%
paste0(., "/folds/") %T>%
dir.create()
# file_dem_mask_100m <- paste0(dir_folds, "/dem_mask_100m.tif")
#
# terra::aggregate(
#   DEM_10m,
#   10,
#   fun = fun_agg,
#   cores = 19,
#   filename = file_dem_mask_100m
# )
#
# dem_mask_100m <- rast(file_dem_mask_100m)
#
# dem_mask_100m2 <- ifel(dem_mask_100m == 1, NA, 1)
file_dem_mask_100m_2 <- paste0(dir_folds, "/dem_mask_100m_2.tif")
# writeRaster(
#   dem_mask_100m2,
#   filename = file_dem_mask_100m_2,
#   overwrite = TRUE,
#   datatype = "INT1U"
#   )
dem_mask_100m2 <- rast(file_dem_mask_100m_2)
plot(dem_mask_100m2)
?app
?writeRaster
fun1 <- function(x, n_layers = 1) {
# if (is.matrix(x) & ncol(x) > 1) {
#   x <- x[, 1]
# }
out <- matrix(numeric(), nrow = length(x), ncol = n_layers)
sumNA <- sum(is.na(x))
out[!is.na(x), ] <- 0 + rpois(n_layers*(length(x) - sumNA), 1)
# out <- x * 0 + rpois(n_layers, 1)
# out <- as.matrix(out, nrow = length(x))
return(out)
}
nlyr_out <- 100
set.seed(8863)
r_poisson <- app(
dem_mask_100m2,
fun = function(i, ff, outlayers) ff(i, n_layers = outlayers),
cores = 19,
ff = fun1,
outlayers = nlyr_out,
filename  = paste0(dir_folds, "/poisson_100m.tif"),
overwrite = TRUE,
wopt = list(
atatype = "INT1U"
)
)
set.seed(8863)
r_poisson <- app(
dem_mask_100m2,
fun = function(i, ff, outlayers) ff(i, n_layers = outlayers),
cores = 19,
ff = fun1,
outlayers = nlyr_out,
filename  = paste0(dir_folds, "/poisson_100m.tif"),
overwrite = TRUE,
wopt = list(
datatype = "INT1U"
)
)
poisson_r <- paste0(dir_folds, "/poisson_100m.tif") %>% rast()
possion_r
poisson_r
plot(poisson_r[[1]])
library(terra)
library(magrittr)
library(tools)
library(dplyr)
library(caret)
library(tibble)
library(tidyr)
library(sf)
library(exactextractr)
library(party)
library(rpart)
library(doParallel)
library(spatstat) # weights
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
testn <- 13
mycrs <- "EPSG:25832"
# Results folder
dir_results <- dir_dat %>%
paste0(., "/results_test_", testn, "/") %T>%
dir.create()
DK_fields <- dir_dat %>%
paste0(., "fields_2022/Marker_2022_slut.shp") %>%
vect()
cov_dir <- dir_dat %>% paste0(., "/covariates")
cov_files <- cov_dir %>% list.files()
cov_names <- cov_files %>% tools::file_path_sans_ext()
cov <- paste0(cov_dir, "/", cov_files) %>%
rast()
names(cov) <- cov_names
crs(cov) <- mycrs
DK_fields
library(terra)
library(magrittr)
library(tools)
library(dplyr)
library(caret)
library(tibble)
library(tidyr)
library(sf)
library(exactextractr)
library(party)
library(rpart)
library(doParallel)
library(spatstat) # weights
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
testn <- 13
mycrs <- "EPSG:25832"
# Results folder
dir_results <- dir_dat %>%
paste0(., "/results_test_", testn, "/") %T>%
dir.create()
# 2 Aggregate covariates to field level
# Load field data (first used repair geometry in ArcGIS)
DK_fields <- dir_dat %>%
paste0(., "fields_2022/Marker_2022_slut.shp") %>%
vect()
# Load covariates
cov_dir <- dir_dat %>% paste0(., "/covariates")
cov_files <- cov_dir %>% list.files()
cov_names <- cov_files %>% tools::file_path_sans_ext()
cov <- paste0(cov_dir, "/", cov_files) %>%
rast()
names(cov) <- cov_names
crs(cov) <- mycrs
covs_not_ogc <- grep('ogc_pi', names(cov), value = TRUE, invert = TRUE)
covs_not_ogc
cov_cats <- dir_code %>%
paste0(., "/cov_categories_20230712.csv") %>%
read.table(
sep = ";",
header = TRUE
)
cov_selected <- cov_cats %>%
filter(anbm_use == 1) %>%
dplyr::select(., name) %>%
unlist() %>%
unname()
?subset
cov %<>% subset(cov_selected)
cov
covs_not_ogc <- grep('ogc_pi', names(cov), value = TRUE, invert = TRUE)
covs_not_ogc
grep('lu_', names(cov), value = TRUE, invert = FALSE)
?grep
cov_dir <- dir_dat %>% paste0(., "/covariates")
cov_files <- cov_dir %>% list.files()
cov_names <- cov_files %>% tools::file_path_sans_ext()
cov <- paste0(cov_dir, "/", cov_files) %>%
rast()
names(cov) <- cov_names
crs(cov) <- mycrs
cov_cats <- dir_code %>%
paste0(., "/cov_categories_20230712.csv") %>%
read.table(
sep = ";",
header = TRUE
)
cov_selected <- cov_cats %>%
filter(anbm_use == 1) %>%
dplyr::select(., name) %>%
unlist() %>%
unname()
cov %<>% subset(cov_selected)
# Deselect covariates that should not be aggregated at field level:
# - field data (imk)
# - climatic data (chelsa)
# - land use (lu)
# - oblique geographic coordinates (ogc_pi)
cov_exclude <- c(
grep('imk_', names(cov), value = TRUE),
grep('chelsa_', names(cov), value = TRUE),
grep('lu_', names(cov), value = TRUE),
grep('ogc_pi', names(cov), value = TRUE)
)
?subset
?setdiff
setdiff(names(cov), cov_exclude)
cov_exclude <- c(
grep('imk_', names(cov), value = TRUE),
grep('chelsa_', names(cov), value = TRUE),
grep('lu_', names(cov), value = TRUE),
grep('ogc_pi', names(cov), value = TRUE),
grep('wetlands_10m', names(cov), value = TRUE),
grep('landscape_', names(cov), value = TRUE),
grep('georeg_', names(cov), value = TRUE),
grep('rvb_bios', names(cov), value = TRUE),
grep('cwl_10m_fuzzy', names(cov), value = TRUE)
)
setdiff(names(cov), cov_exclude)
cov_exclude <- c(
grep('imk_', names(cov), value = TRUE),
grep('chelsa_', names(cov), value = TRUE),
grep('lu_', names(cov), value = TRUE),
grep('ogc_pi', names(cov), value = TRUE),
grep('wetlands_10m', names(cov), value = TRUE),
grep('landscape_', names(cov), value = TRUE),
grep('georeg_', names(cov), value = TRUE),
grep('rvb_bios', names(cov), value = TRUE),
grep('cwl_10m_fuzzy', names(cov), value = TRUE)
)
cov_for_aggr <- setdiff(names(cov), cov_exclude)
profiles_shp <- dir_dat %>%
paste0(
.,
"/observations/profiles/Profiles_coordinates_new/",
"Profiles_coordinates_new.shp"
) %>%
vect()
profiles_db <- dir_dat %>%
paste0(., "/observations/profiles/DDJD2023.accdb")
con3 <- odbcConnectAccess2007(profiles_db)
library(RODBC)
con3 <- odbcConnectAccess2007(profiles_db)
profiles_DC<- sqlFetch(con3, "PROFIL")
profiles_DC
profiles_DC<- sqlFetch(con3, "PROFIL") %>%
select(c(PROFILNR, DRAENKL))
profiles_DC
profiles_DC<- sqlFetch(con3, "PROFIL") %>%
select(c(PROFILNR, DRAENKL)) %>%
drop_na()
profiles_DC
plot(profiles_DC$DRAENKL)
profiles_DC<- sqlFetch(con3, "PROFIL") %>%
select(c(PROFILNR, DRAENKL)) %>%
drop_na() %>%
filter(!(DRAENKL %in% 1:5))
profiles_DC<- sqlFetch(con3, "PROFIL") %>%
select(c(PROFILNR, DRAENKL)) %>%
drop_na() %>%
filter(DRAENKL %in% 1:5)
plot(profiles_DC$DRAENKL)
?left_join
profiles_shp
profiles_shp %>% values
inner_join(
values(profiles_shp),
profiles_DC,
"PROFILNR"
)
profiles_shp <- dir_dat %>%
paste0(
.,
"/observations/profiles/Profiles_coordinates_new/",
"Profiles_coordinates_new.shp"
) %>%
vect()
# 1.4.2: Profiles: Texture
profiles_db <- dir_dat %>%
paste0(., "/observations/profiles/DDJD2023.accdb")
con3 <- odbcConnectAccess2007(profiles_db)
profiles_DC <- sqlFetch(con3, "PROFIL") %>%
select(c(PROFILNR, DRAENKL)) %>%
drop_na() %>%
filter(DRAENKL %in% 1:5)
profiles_DC %<>% inner_join(
x = values(profiles_shp),
y = .,
by = "PROFILNR"
)
profiles_DC
?arrange
profiles_DC <- sqlFetch(con3, "PROFIL") %>%
select(c(PROFILNR, DRAENKL)) %>%
drop_na() %>%
filter(DRAENKL %in% 1:5)
profiles_DC %<>% inner_join(
x = values(profiles_shp),
y = .,
by = "PROFILNR"
) %>% arrange(
"PROFILNR"
)
profiles_DC
profiles_DC %>% str
profiles_DC %<>% inner_join(
x = values(profiles_shp),
y = .,
by = "PROFILNR"
) %>% arrange(
"PROFILNR"
)
profiles_DC <- sqlFetch(con3, "PROFIL") %>%
select(c(PROFILNR, DRAENKL)) %>%
drop_na() %>%
filter(DRAENKL %in% 1:5)
profiles_DC %<>% inner_join(
x = values(profiles_shp),
y = .,
by = "PROFILNR"
) %>% arrange(
"PROFILNR"
)
profiles_DC
plot(profiles_DC$PROFILNR)
profiles_DC <- sqlFetch(con3, "PROFIL") %>%
select(c(PROFILNR, DRAENKL)) %>%
drop_na() %>%
filter(DRAENKL %in% 1:5)
profiles_DC %<>% inner_join(
x = values(profiles_shp),
y = .,
by = "PROFILNR"
) %>% arrange(
PROFILNR
)
profiles_DC
plot(profiles_DC$DRAENKL)
?vect
profiles_DC <- sqlFetch(con3, "PROFIL") %>%
select(c(PROFILNR, DRAENKL)) %>%
drop_na() %>%
filter(DRAENKL %in% 1:5)
profiles_DC %<>% inner_join(
x = values(profiles_shp),
y = .,
by = "PROFILNR"
) %>% arrange(
PROFILNR
) %>% vect(
geom = c("x", "y"),
crs = mycrs,
keepgeom = TRUE
)
plot(profiles_DC, "DRAENKL")
