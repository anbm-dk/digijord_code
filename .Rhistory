# - SOC (OK)
# - CaCO3 (OK)
# - Indicate removal of SOM for texture analyses (OK)
# - BD (later)
# - pH (OK)
# - Nutrients: Pt, Kt, Mgt, CUT, TOTALN TOTALP ORGAP    K   NA   CA   MG (later)
# - Water retention (later)
# - Texture sub-fractions: Gsilt, GfinSD, GRVSILT S63 S125 S200 S500 (later)
mycolnames <- c(
"ID_new",
"db",
"ID_old",
"date",
"UTMX",
"UTMY",
"upper",
"lower",
"clay",
"silt",
"fine_sand",
"coarse_sand",
"SOC",
"CaCO3",
"SOM_removed",
"pH",
"N",
"BD",
"CEC"
)
# Start up
library(terra)
library(magrittr)
library(RODBC)
library(dplyr)
library(tidyr)
library(stringi)
library(readxl)
dir_code <- getwd()
root <- dirname(dir_code)
dir_dat <- paste0(root, "/digijord_data/")
# 1.1: Load DSC observations
dsc <- dir_dat %>%
paste0(
.,
"/observations/DanishSoilClassification/DLJ/DLJmDecimaler_DKBH.shp"
) %>%
vect()
# 1.2: Load SEGES samples
SEGES <- dir_dat %>%
paste0(
.,
"/observations/SEGES_samples/SEGES_samples_cleaned.csv"
) %>%
read.table(
sep = ";",
header = TRUE
)
# 1.3: Load SINKS data
# In the long run I should use all the data.
# However, I will use the topsoil until the dataset has been fixed.
# Use pivot_longer to get a row for each sample.
SINKS_db <- dir_dat %>%
paste0(., "/observations/SINKS/SinksDatabase_V2.mdb")
con2 <- odbcConnectAccess2007(SINKS_db)
SINKS <- sqlFetch(con2, "bMHG_RODALTDETDUVIL_01JAN2011")
# 1.4: Profiles:
# 1.4.1: Profiles coordinates
profiles_shp <- dir_dat %>%
paste0(
.,
"/observations/profiles/Profiles_coordinates_new/Profiles_coordinates_new.shp"
) %>%
vect()
# 1.4.2: Profiles: Texture
profiles_db <- dir_dat %>%
paste0(., "/observations/profiles/DDJD2023.accdb")
con3 <- odbcConnectAccess2007(profiles_db)
profiles_texture <- sqlFetch(con3, "ANALYSE")
# 1.4.3: Profiles: Horizons
profiles_horizons <- dir_dat %>%
paste0(
.,
"/observations/profiles/DDJD_horizons/DDJD_HORISONT_FRA_TIL.xlsx"
) %>%
read_excel()
# 1.5: Profiles: Water retention (later)
profiles_retention <-  sqlFetch(con3, "VANDRETENTION")
# 1.6: Profiles: Drainage (later)
# 1.7: Lucas database?
# 1.8: Forest samples
forests_tax <- dir_dat %>%
paste0(
.,
"/observations/forest_samples/Taksation_ETRS89.xlsx"
) %>%
read_excel(.name_repair = "universal")
forests_dsc <- dir_dat %>%
paste0(
.,
"/observations/forest_samples/Skovjord_ETRS89.xlsx"
) %>%
read_excel(.name_repair = "universal")
forests_tax
forests_dsc
forests_tax2 <- forests_tax %>%
mutate(
db = "Forest evaluation",
ID_old = key,
date = "1980",
UTMX = UTMØ,
UTMY = UTMN,
upper = 0,
lower = 20,
SOM_removed = 0,
SOC = Humus*0.586
) %>%
filter(
!is.na(Humus) & !is.na(UTMX) & !is.na(UTMX)
)
forests_dsc2 <- forests_dsc %>%
arrange(Lokalitet) %>%
group_by(Lokalitet) %>%
arrange(Dybde.fra) %>%
mutate(
db = "Forests DSC",
ID_old = paste0(Lokalitet, "_", row_number()),
date = "1991",
UTMX = UTMØ,
UTMY = UTMN,
upper = Dybde.fra,
lower = Dybde.til,
SOM_removed = 0,
CaCO3 = case_when(
is.na(CaCO3) ~ 0,
.default = CaCO3
),
SOC = Humus*0.586,
Finsand = Grovsilt + ..63.mym + ..125.mym,
Grovsand = ..200.mym + ..500.mym
) %>%
ungroup() %>%
arrange(Lokalitet) %>% as.data.frame()
forests_dsc2
forests_tax2
forests_tax2 %>% as.data.frame()
bind_rows(forests_tax2, forests_dsc2)
forests_tax2 <- forests_tax %>%
mutate(
db = "Forest evaluation",
ID_old = as.character(key),
date = "1980",
UTMX = UTMØ,
UTMY = UTMN,
upper = 0,
lower = 20,
SOM_removed = 0,
SOC = Humus*0.586
) %>%
filter(
!is.na(Humus) & !is.na(UTMX) & !is.na(UTMX)
)
forests_dsc2 <- forests_dsc %>%
arrange(Lokalitet) %>%
group_by(Lokalitet) %>%
arrange(Dybde.fra) %>%
mutate(
db = "Forests DSC",
ID_old = paste0(Lokalitet, "_", row_number()),
date = "1991",
UTMX = UTMØ,
UTMY = UTMN,
upper = Dybde.fra,
lower = Dybde.til,
SOM_removed = 0,
CaCO3 = case_when(
is.na(CaCO3) ~ 0,
.default = CaCO3
),
SOC = Humus*0.586,
Finsand = Grovsilt + ..63.mym + ..125.mym,
Grovsand = ..200.mym + ..500.mym
) %>%
ungroup() %>%
arrange(Lokalitet)
bind_rows(forests_tax2, forests_dsc2)
forests_all <- bind_rows(forests_tax2, forests_dsc2)
forests_tax2 <- forests_tax %>%
mutate(
db = "Forest evaluation",
ID_old = as.character(key),
date = "1980",
upper = 0,
lower = 20,
) %>%
filter(
!is.na(Humus) & !is.na(UTMX) & !is.na(UTMX)
)
forests_tax2 <- forests_tax %>%
mutate(
db = "Forest evaluation",
ID_old = as.character(key),
date = "1980",
upper = 0,
lower = 20,
) %>%
filter(
!is.na(Humus) & !is.na(UTMN) & !is.na(UTMØ)
)
forests_dsc2 <- forests_dsc %>%
arrange(Lokalitet) %>%
group_by(Lokalitet) %>%
arrange(Dybde.fra) %>%
mutate(
db = "Forests DSC",
ID_old = paste0(Lokalitet, "_", row_number()),
date = "1991",
upper = Dybde.fra,
lower = Dybde.til,
CaCO3 = case_when(
is.na(CaCO3) ~ 0,
.default = CaCO3
),
Finsand = Grovsilt + ..63.mym + ..125.mym,
Grovsand = ..200.mym + ..500.mym
) %>%
ungroup() %>%
arrange(Lokalitet)
forests_all <- bind_rows(forests_tax2, forests_dsc2) %>%
mutate(
UTMX = UTMØ,
UTMY = UTMN,
SOM_removed = 0,
SOC = Humus*0.586
)
forests_all
forests_all %>% as.data.frame()
plot(forests_tax$key)
forests_tax2 <- forests_tax %>%
mutate(
db = "Forest evaluation",
ID_old = as.character(key),
date = "1980",
upper = 0,
lower = 20,
) %>%
filter(
!is.na(Humus) & !is.na(UTMN) & !is.na(UTMØ)
)
forests_dsc2 <- forests_dsc %>%
arrange(Lokalitet) %>%
group_by(Lokalitet) %>%
arrange(Dybde.fra) %>%
mutate(
db = "Forests DSC",
ID_old = paste0(Lokalitet, "_", row_number()),
date = "1991",
upper = Dybde.fra,
lower = Dybde.til,
CaCO3 = case_when(
is.na(CaCO3) ~ 0,
.default = CaCO3
),
Finsand = Grovsilt + ..63.mym + ..125.mym,
Grovsand = ..200.mym + ..500.mym
) %>%
ungroup() %>%
arrange(Lokalitet)
forests_all <- bind_rows(forests_tax2, forests_dsc2) %>%
mutate(
UTMX = UTMØ,
UTMY = UTMN,
SOM_removed = 0,
SOC = Humus*0.586
)
forests_all
forests_all %>%
mutate(tsum = Ler + Silt + Finsand + Grovsand) %>%
ggplot(aes(x = SOC, y = tsum)) + geom_point()
library(ggplot2)
forests_all %>%
mutate(tsum = Ler + Silt + Finsand + Grovsand) %>%
ggplot(aes(x = SOC, y = tsum)) + geom_point()
forests_all %>%
mutate(
tsum = Ler + Silt + Finsand + Grovsand,
tsum_all = Ler + Silt + Finsand + Grovsand + Humus + CaCO3
) %>%
ggplot(aes(x = SOC, y = tsum_all)) + geom_point()
forests_all %>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ggplot(aes(x = SOC, y = tsum_all)) + geom_point()
forests_all %>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ggplot(aes(x = SOC, y = tsum)) + geom_point()
plot(forests_all$Ler)
forests_all %>% arrange(Ler)
forests_all %>% arrange(Ler) %>% as.data.frame()
forests_tax2 <- forests_tax %>%
mutate(
db = "Forest evaluation",
ID_old = as.character(key),
date = "1980",
upper = 0,
lower = 20,
) %>%
filter(
!is.na(Humus) & !is.na(UTMN) & !is.na(UTMØ)
)
forests_dsc2 <- forests_dsc %>%
mutate(
across(
where(is.numeric),
function(x) replace(x, x == -1, NA)) # Remove negative values
) %>%
arrange(Lokalitet) %>%
group_by(Lokalitet) %>%
arrange(Dybde.fra) %>%
mutate(
db = "Forests DSC",
ID_old = paste0(Lokalitet, "_", row_number()),
date = "1991",
upper = Dybde.fra,
lower = Dybde.til,
CaCO3 = case_when(
is.na(CaCO3) ~ 0,
.default = CaCO3
),
Finsand = Grovsilt + ..63.mym + ..125.mym,
Grovsand = ..200.mym + ..500.mym
) %>%
ungroup() %>%
arrange(Lokalitet)
forests_all <- bind_rows(forests_tax2, forests_dsc2) %>%
mutate(
UTMX = UTMØ,
UTMY = UTMN,
SOM_removed = 0,
SOC = Humus*0.586
)
forests_all %>% arrange(Ler) %>% as.data.frame()
library(ggplot2)
forests_all %>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ggplot(aes(x = SOC, y = tsum)) + geom_point()
library(ggplot2)
forests_all %>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ggplot(aes(x = SOC, y = tsum_all)) + geom_point()
forests_all %>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
)
forests_all %>%
ggplot(aes(x = SOC, y = tsum_all)) + geom_point()
forests_all <- bind_rows(forests_tax2, forests_dsc2) %>%
mutate(
UTMX = UTMØ,
UTMY = UTMN,
SOM_removed = 0,
SOC = Humus*0.586
)
library(ggplot2)
forests_all %>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ungroup()
forests_all %>%
ggplot(aes(x = SOC, y = tsum_all)) + geom_point()
forests_all
forests_all <- bind_rows(forests_tax2, forests_dsc2) %>%
mutate(
UTMX = UTMØ,
UTMY = UTMN,
SOM_removed = 0,
SOC = Humus*0.586
)
library(ggplot2)
forests_all %>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ungroup()
forests_all %>%
ggplot(aes(x = SOC, y = tsum_all)) + geom_point()
forests_all %<>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ungroup()
forests_all %>%
ggplot(aes(x = SOC, y = tsum_all)) + geom_point()
forests_all %>% filter(tsum_all < 99 & SOC < 5)
forests_all %>% filter(tsum_all < 99 & SOC < 5) %>% as.data.frame()
forests_all %<>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ungroup() %>%
mutate(
tsum = case_when(
tsum == 0 ~ NA
.default = tsum
forests_all <- bind_rows(forests_tax2, forests_dsc2) %>%
mutate(
UTMX = UTMØ,
UTMY = UTMN,
SOM_removed = 0,
SOC = Humus*0.586
) %>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ungroup() %>%
mutate(
tsum = case_when(
tsum == 0 ~ NA,
.default = tsum
)
)
forests_all %>%
ggplot(aes(x = SOC, y = tsum)) + geom_point()
forests_all %>%
mutate(
clay = Ler * 100 / tsum,
silt = Silt * 100 / tsum,
fine_sand = Finsand * 100 / tsum,
coarse_sand = Grovsand * 100 / tsum
) %>% as.data.frame()
forests_all %>%
mutate(
clay = Ler * 100 / tsum,
silt = Silt * 100 / tsum,
fine_sand = Finsand * 100 / tsum,
coarse_sand = Grovsand * 100 / tsum
) %>% slice_sample(n = 20)%>% as.data.frame()
forests_all %>%
mutate(
clay = Ler * 100 / tsum,
silt = Silt * 100 / tsum,
fine_sand = Finsand * 100 / tsum,
coarse_sand = Grovsand * 100 / tsum
) %>% slice_sample(n = 20)%>% as.data.frame()
forests_all <- bind_rows(forests_tax2, forests_dsc2) %>%
mutate(
UTMX = UTMØ,
UTMY = UTMN,
SOM_removed = 0,
SOC = Humus*0.586
) %>%
rowwise() %>%
mutate(
tsum = sum(Ler, Silt, Finsand, Grovsand, na.rm = TRUE),
tsum_all = sum(Ler, Silt, Finsand, Grovsand, Humus, CaCO3, na.rm = TRUE)
) %>%
ungroup() %>%
mutate(
tsum = case_when(
tsum == 0 ~ NA,
.default = tsum
),
clay = Ler * 100 / tsum,
silt = Silt * 100 / tsum,
fine_sand = Finsand * 100 / tsum,
coarse_sand = Grovsand * 100 / tsum
) %>%
select(any_of(mycolnames))
forests_all
forests_all %>% as.data.frame()
write.table(
forests_all,
paste0(dir_obs_proc, "forest_samples.csv"),
row.names = FALSE,
sep = ";"
)
dir_obs_proc <- dir_dat %>%
paste0(., "/observations/processed/") %T>%
dir.create()
write.table(
forests_all,
paste0(dir_obs_proc, "forest_samples.csv"),
row.names = FALSE,
sep = ";"
)
